<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ajoneuvon huoltoraportti</title>
    <link rel="stylesheet" href="./css/all.min.css" onerror="this.onerror=null;this.href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';">

    <style>
        :root {
            --primary-color: #009eb8;
            --bg-color: #f4f4f4;
            --border-color: #ccc;
            --success-color: #96C11F;
            --warning-color: #FF0000;
            --neutral-color: #C7C7C7;
            --success-bg: rgba(150, 193, 31, 0.1);
            --warning-bg: rgba(255, 0, 0, 0.1);
            --neutral-bg: rgba(199, 199, 199, 0.1);
        }
        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #e9ecef;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* Layout & Containers */
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 90vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .header h1 {
            margin: 0;
            font-size: 21px;
            color: #444;
        }

        .nav-buttons button {
            background: none;
            border: 1px solid #ccc;
            padding: 10px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            margin-left: 2px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            line-height: 1;
        }

        .nav-buttons button:hover {
            background-color: #eee;
        }

        .nav-buttons button.primary {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .nav-buttons button.primary:hover {
            filter: brightness(90%);
        }
        .nav-buttons button.report-save-btn.unsaved,
        .nav-buttons button.config-save-btn.unsaved {
            background-color: #d9534f;
            color: #fff;
            border-color: #d9534f;
        }
        .nav-buttons button.report-save-btn.unsaved:hover,
        .nav-buttons button.config-save-btn.unsaved:hover {
            filter: brightness(90%);
            background-color: #d9534f;
        }

        .nav-buttons button.danger {
            background-color: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .nav-buttons button.danger:disabled {
            background-color: #e6aeb3;
            border-color: #e6aeb3;
            cursor: not-allowed;
        }
        
        .nav-buttons button.active {
            background-color: #6c757d;
            color: white;
        }

        /* Mobile Nav Adjustments */
        .btn-text-short { display: none; }
        @media (max-width: 600px) {
            .btn-text { display: none; }
            .btn-text-short { display: inline; }
            .btn-config .btn-text, .btn-config .btn-text-short { display: none; }
            body { padding: 10px; }
            .container { padding: 15px; }
			#btn-select-mode .btn-text,
            #btn-delete-selected .btn-text { display: inline; }
        }

        /* Views */
        .view { display: none; }
        .view.active { display: block; }
        #dashboard-view {
            position: relative;
        }

        .dashboard-toolbar {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .dashboard-toolbar-actions {
            display: inline-flex;
            gap: 4px;
            margin-left: auto;
        }
        .dashboard-toolbar-actions button {
            margin-left: 0;
        }

        /* Dashboard List */
        .report-list-card {
            margin-top: 15px;
            background: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #eee;
            overflow: hidden;
        }
        .report-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        .report-list th, .report-list td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .report-list th {
            background-color: var(--primary-color);
            color: #fff;
            font-weight: 600;
        }

        .report-list tr:hover {
            background-color: #f1f1f1;
            cursor: pointer;
        }
        .report-list tr.row-selected {
            background-color: #e9ecef;
        }
        .view.selection-mode .report-list tr.row-selected:hover {
            background-color: #e9ecef;
        }
        .col-plate-mobile-vehicle {
            display: none;
        }
        
        /* Selection Mode Styles */
        .col-select {
            width: 40px;
            text-align: center;
            display: none; /* Hidden by default */
        }
        .view.selection-mode .col-select {
            display: table-cell;
        }
        
        .row-checkbox {
            transform: scale(1.2);
            cursor: pointer;
        }
        @media (max-width: 600px) {
            .report-list-card {
                margin-top: 10px;
                background: transparent;
                border: 0;
                box-shadow: none;
                overflow: visible;
            }
            .report-list {
                border-collapse: separate;
                border-spacing: 0px 0px;
            }
            .report-list thead {
                display: none;
            }
            .report-list tbody tr {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-areas:
                    "date customer"
                    "plate plate";
                gap: 4px 10px;
                margin-bottom: 2px;
                padding: 10px 12px;
                border: 1px solid #e5e5e5;
                border-color: color-mix(in srgb, var(--primary-color) 24%, #d8e1e6);
                border-radius: 8px;
                background: #fff;
                box-shadow: 0 2px 8px color-mix(in srgb, var(--primary-color) 9%, transparent);
                transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
            }
            .report-list tbody tr:last-child {
                margin-bottom: 0;
            }
            .report-list tbody tr:hover {
                background: #fff;
                border-color: color-mix(in srgb, var(--primary-color) 38%, #bccfd8);
                box-shadow: 0 4px 12px color-mix(in srgb, var(--primary-color) 14%, transparent);
            }
            .report-list tbody td {
                display: block;
                padding: 0;
                border-bottom: 0;
            }
            .report-list tbody td.col-date {
                grid-area: date;
                font-size: 14px;
                color: #666;
            }
            .report-list tbody td.col-customer {
                grid-area: customer;
                text-align: right;
                font-weight: 400;
                min-width: 0;
            }
            .report-list tbody td.col-plate {
                grid-area: plate;
                white-space: normal;
                font-weight: 700;
            }
            .report-list tbody td.col-vehicle {
                display: none;
            }
            .report-list tbody td.col-select {
                display: none;
            }
            .col-plate-mobile-vehicle {
                display: inline;
                font-size: 13px;
                color: #666;
                font-weight: 400;
            }
            .view.selection-mode .report-list tbody tr {
                grid-template-columns: 28px 1fr auto;
                grid-template-areas:
                    "check date customer"
                    "check plate plate";
            }
            .view.selection-mode .report-list tbody tr.row-selected {
                background: color-mix(in srgb, var(--primary-color) 10%, #fff);
                border-color: color-mix(in srgb, var(--primary-color) 52%, #b7cad3);
                box-shadow: 0 0 0 1px color-mix(in srgb, var(--primary-color) 24%, transparent);
            }
            .view.selection-mode .report-list tbody td.col-select {
                display: flex;
                grid-area: check;
                align-items: flex-start;
                justify-content: center;
                padding-top: 2px;
            }
            .calendar-month-grid {
                grid-template-columns: 1fr;
            }
            .calendar-day,
            .calendar-day-placeholder {
                min-height: 36px;
            }
        }

        .search-bar {
            width: 100%;
            padding: 10px;
            margin-bottom: 0;
            padding-right: 34px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .search-bar-wrap {
            position: relative;
            margin-bottom: 15px;
        }
        .search-clear-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 0;
            border-radius: 999px;
            background: #8f98a1;
            color: #fff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }
        .search-clear-btn:hover {
            background: #6f7780;
        }
        .search-clear-btn.hidden {
            display: none;
        }

        .dashboard-calendar {
            display: none;
            margin-top: 10px;
        }
        .calendar-month-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 14px;
        }
        @media (max-width: 700px) {
            .calendar-month-grid {
                grid-template-columns: 1fr;
            }
        }
        .calendar-month-card {
            border: 1px solid #e5e5e5;
            border-color: color-mix(in srgb, var(--primary-color) 28%, #d5dde1);
            border-radius: 8px;
            padding: 12px;
            background: #fff;
            box-shadow: 0 2px 8px color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        .calendar-month-title {
            font-weight: 700;
            color: #444;
            margin-bottom: 10px;
            text-transform: capitalize;
        }
        .calendar-weekdays,
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 4px;
        }
        .calendar-weekdays div {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            color: #666;
            padding: 3px 0;
        }
        .calendar-day,
        .calendar-day-placeholder {
            min-height: 40px;
            border-radius: 6px;
        }
        .calendar-day-placeholder {
            background: #f8f9fa;
        }
        .calendar-day {
            border: 1px solid #e8e8e8;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            color: #333;
            display: block;
            position: relative;
            text-align: left;
            padding: 6px 7px 14px 7px;
            transition: background-color 0.15s, border-color 0.15s;
        }
        .calendar-day:hover {
            border-color: #bbb;
            background: #f8f8f8;
        }
        .calendar-day.today {
            border-color: var(--primary-color);
        }
        .calendar-day .day-number {
            font-weight: 600;
            line-height: 1;
            display: inline-block;
        }
        .calendar-day .day-count {
            position: absolute;
            right: 5px;
            bottom: 4px;
            font-size: 10px;
            font-weight: 700;
            color: #444;
            line-height: 1;
            padding: 1px 3px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.65);
        }
        .calendar-day.has-reports-1 {
            background: #eaf5f8;
            border-color: #cfe6ec;
        }
        .calendar-day.has-reports-2 {
            background: #cfe6ec;
            border-color: #a4d2dd;
        }
        .calendar-day.has-reports-3 {
            background: #a4d2dd;
            border-color: #79bccd;
        }
        .calendar-controls {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .calendar-controls button {
            margin-left: 0;
        }
        .calendar-day-menu {
            position: fixed;
            z-index: 2000;
            width: min(360px, calc(100vw - 20px));
            max-height: min(420px, calc(100vh - 20px));
            overflow: auto;
            background: #fff;
            border: 1px solid #d8d8d8;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.14);
            padding: 12px;
        }
        .calendar-day-menu.hidden {
            display: none;
        }
        .calendar-day-menu-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #444;
            text-transform: capitalize;
        }
        .calendar-day-menu-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        .calendar-day-menu-empty,
        .calendar-day-menu-item {
            padding: 7px 8px;
            border-radius: 6px;
            border: 1px solid #efefef;
            font-size: 13px;
        }
        .calendar-day-menu-empty {
            background: #fafafa;
            color: #666;
            border-style: dashed;
        }
        .calendar-day-menu-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            align-items: center;
            background: #fff;
            width: 100%;
            text-align: left;
            cursor: pointer;
            appearance: none;
            font-family: inherit;
            color: #333;
        }
        .calendar-day-menu-item:hover {
            background: #f7f7f7;
        }
        .calendar-day-menu-plate {
            font-weight: 700;
        }
        .calendar-day-menu-customer {
            color: #555;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .calendar-day-menu-create {
            background: none;
            border: 1px solid #ccc;
            padding: 10px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            line-height: 1;
            margin-left: 0;
            width: 100%;
            justify-content: center;
        }
        .calendar-day-menu-create:hover {
            background-color: #eee;
        }
        #dashboard-view.calendar-mode .search-bar,
        #dashboard-view.calendar-mode .search-bar-wrap,
        #dashboard-view.calendar-mode .report-list-card,
        #dashboard-view.calendar-mode .report-list,
        #dashboard-view.calendar-mode .pagination-container,
        #dashboard-view.calendar-mode #btn-select-mode,
        #dashboard-view.calendar-mode #btn-delete-selected {
            display: none;
        }
        #dashboard-view.calendar-mode .dashboard-calendar {
            display: block;
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }
        .pagination-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }
        .pagination-btn:disabled {
            background: #f4f4f4;
            color: #aaa;
            cursor: default;
        }
        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        /* Form Sections */
        .document-section {
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .document-section-header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .document-section-content { padding: 14px; }

        /* Responsive Form Grid */
        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }
        @media (max-width: 800px) { .form-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 400px) { .form-row { grid-template-columns: 1fr; } }
        @media (max-width: 800px) {
            .general-info-row .preinfo-group { grid-column: 1 / -1; }
            .general-info-row .preinfo-input { height: 84px; }
        }
        @media (max-width: 400px) {
            .general-info-row .preinfo-group { grid-column: auto; }
            .general-info-row .preinfo-input { height: auto; min-height: 112px; }
        }

        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .form-group.hidden { display: none; }

        .form-group label {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        .form-control {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            display: block;
            margin: 0;
            min-width: 0;
            max-width: 100%;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 60px;
        }

        /* Traffic Light Selector */
        .maintenance-item {
            margin-bottom: 20px;
            border-bottom: 1px solid #f9f9f9;
            padding-bottom: 15px;
        }

        .maintenance-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 15px;
        }
        .maintenance-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .maintenance-title-row .maintenance-title {
            margin-bottom: 0;
            flex: 1;
            min-width: 0;
        }
        .item-note-toggle {
            border: 1px solid #d1d1d1;
            border-radius: 999px;
            background: #fff;
            color: #555;
            font-size: 12px;
            line-height: 1;
            padding: 3px 6px;
            cursor: pointer;
            white-space: nowrap;
        }
        .item-note-toggle:hover {
            background: #f3f3f3;
        }
        .item-note-toggle.active {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background: #eef9fc;
        }
        .maintenance-subitems-row {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
        }
        .maintenance-subitem-btn {
            border: 1px solid #d6dbe0;
            background: #fff;
            color: #3f4950;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            line-height: 1.25;
            cursor: pointer;
            transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
        }
        .maintenance-subitem-btn:hover {
            background: #f1f3f5;
            border-color: #c6ccd2;
        }
        .maintenance-subitem-btn.selected {
            border-color: var(--primary-color);
            background: #e8f6fa;
            color: #0f5e6e;
        }
        .maintenance-note-row {
            margin-top: 8px;
        }
        .maintenance-note-input {
            width: 100%;
        }
        .legacy-section-header {
            background-color: #f8d7da;
            color: #842029;
        }
        .legacy-item {
            background: #f8f9fa;
            border: 1px dashed #ced4da;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 12px;
        }
        .legacy-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }
        .legacy-title {
            margin: 0;
            color: #842029;
        }
        .legacy-appendix {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }
        .legacy-status-row {
            font-size: 14px;
            color: #555;
        }
        .legacy-remove-btn {
            border: none;
            background: transparent;
            color: #a52a37;
            text-decoration: underline;
            font-size: 13px;
            cursor: pointer;
            padding: 0;
            white-space: nowrap;
        }
        .legacy-remove-btn:hover {
            color: #842029;
        }
        .legacy-map-row {
            margin-top: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .legacy-map-select {
            min-width: 240px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 6px 8px;
            background: #fff;
        }
        .legacy-map-btn {
            border: 1px solid #0d6efd;
            background: #0d6efd;
            color: #fff;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 13px;
        }
        .legacy-map-btn:disabled {
            background: #9ec5fe;
            border-color: #9ec5fe;
            cursor: default;
        }
        .legacy-help-text {
            margin: 0 0 10px 0;
            line-height: 1.35;
            font-size: 14px;
            color: #664d03;
        }
        .report-update-banner {
            border: 1px solid #ffe69c;
            background: #fff8e1;
            color: #664d03;
            border-radius: 6px;
            padding: 12px 14px;
            margin-bottom: 16px;
        }
        .report-update-banner p {
            margin: 0 0 8px 0;
            line-height: 1.35;
            font-size: 14px;
        }
        .report-update-banner p:last-child {
            margin-bottom: 0;
        }
        .report-update-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
        }
        .report-update-actions button {
            border: 1px solid #0d6efd;
            background: #0d6efd;
            color: #fff;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
        }

        .status-selector {
            display: flex;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .status-option {
            flex: 1;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 14px;
            user-select: none;
            border-right: 1px solid #eee;
        }
        .status-option:last-child { border-right: none; }
        .status-option i { margin-right: 8px; font-size: 18px; color: #ddd; }
        .status-option:hover { background-color: #f9f9f9; }

        @media (max-width: 400px) {
            .status-option { font-size: 12px; padding: 8px; }
            .status-option i { margin-right: 4px; font-size: 14px; }
        }

        /* Active States */
        .status-option[data-value="done"].selected { background-color: var(--success-bg); font-weight: bold; }
        .status-option[data-value="done"].selected i { color: var(--success-color); }

        .status-option[data-value="not_done"].selected { background-color: var(--warning-bg); font-weight: bold; }
        .status-option[data-value="not_done"].selected i { color: var(--warning-color); }

        .status-option[data-value="na"].selected { background-color: var(--neutral-bg); font-weight: bold; }
        .status-option[data-value="na"].selected i { color: var(--neutral-color); }

        .maintenance-set-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .maintenance-set-chip {
            border: 1px solid #d4dadd;
            background: #fff;
            color: #34444d;
            border-radius: 999px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
        }
        .maintenance-set-chip:hover {
            background: #f3f5f6;
        }
        .maintenance-set-chip:disabled {
            cursor: default;
            color: #8b9499;
            border-color: #e0e4e7;
            background: #f8f9fa;
        }

        /* Config Editor */
        .config-help {
            margin: 0 0 12px;
            color: #666;
            font-size: 14px;
        }
        .config-editor {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .config-groups {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .config-group {
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            overflow: hidden;
        }
        .config-group.dragging {
            opacity: 0.55;
        }
        .config-group.drag-over {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 158, 184, 0.12);
        }
        .config-group-header {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 8px;
            align-items: center;
            padding: 10px 12px;
            background: #f3f3f3;
            border-bottom: 1px solid #e6e6e6;
        }
        .drag-handle {
            cursor: grab;
            user-select: none;
            color: #777;
            font-size: 18px;
            line-height: 1;
        }
        .config-group-header:active .drag-handle,
        .config-item:active .drag-handle {
            cursor: grabbing;
        }
        .config-title-input,
        .config-item-input {
            width: 100%;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            padding: 7px 8px;
            font-size: 14px;
            box-sizing: border-box;
            background: #fff;
        }
        .config-title-input:focus,
        .config-item-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .config-group-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 12px 12px;
            min-height: 42px;
        }
        .config-group-items.drop-target {
            background: rgba(0, 158, 184, 0.08);
        }
        .config-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid #e3e3e3;
            border-radius: 4px;
            padding: 6px 8px;
            background: #fff;
        }
        .config-item-main {
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 8px;
            align-items: center;
        }
        .config-subitems {
            margin-left: 26px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .config-subitem-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 6px;
            align-items: center;
        }
        .config-subitem-input {
            width: 100%;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 13px;
            box-sizing: border-box;
            background: #fff;
        }
        .config-subitem-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .config-subitem-remove {
            padding: 5px 8px;
        }
        .config-item.dragging {
            opacity: 0.55;
        }
        .config-item.drag-over {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 158, 184, 0.12);
        }
        .config-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .cfg-btn {
            border: 1px solid #cfcfcf;
            border-radius: 4px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
            padding: 6px 9px;
        }
        .cfg-btn:hover {
            background: #f5f5f5;
        }
        .cfg-btn-danger {
            border-color: #e0a7ad;
            color: #a52a37;
            background: #fff9fa;
        }
        .cfg-btn-danger:hover {
            background: #fff1f3;
        }
        .config-json-preview {
            margin: 0;
            width: 100%;
            min-height: 240px;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            resize: vertical;
            box-sizing: border-box;
        }
        .config-json-details {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
            padding: 8px;
        }
        .config-json-details summary {
            cursor: pointer;
            font-weight: 600;
            color: #555;
            user-select: none;
        }
        .config-json-details[open] summary {
            margin-bottom: 8px;
        }
        .maintenance-set-create-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            margin-bottom: 12px;
        }
        .maintenance-set-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .maintenance-set-card {
            border: 1px solid #dcdfe3;
            border-radius: 6px;
            background: #fafbfc;
            padding: 10px;
        }
        .maintenance-set-summary {
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px;
            align-items: center;
            user-select: none;
            font-weight: 600;
            list-style: none;
        }
        .maintenance-set-summary::marker {
            content: '';
        }
        .maintenance-set-summary::-webkit-details-marker {
            display: none;
        }
        .maintenance-set-summary-caret {
            color: #66737b;
            font-size: 12px;
            width: 12px;
            text-align: center;
        }
        .maintenance-set-summary-meta {
            font-size: 12px;
            color: #6b7378;
            font-weight: normal;
            text-align: right;
        }
        .maintenance-set-body {
            margin-top: 10px;
        }
        .maintenance-set-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        .maintenance-set-entry-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .maintenance-set-entry {
            border: 1px solid #e5e8eb;
            border-radius: 5px;
            background: #fff;
            padding: 8px;
        }
        .maintenance-set-entry-main {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 8px;
            align-items: center;
        }
        .maintenance-set-entry-status {
            min-width: 125px;
            border: 1px solid #d4d4d4;
            border-radius: 4px;
            padding: 6px 8px;
            background: #fff;
        }
        .maintenance-set-entry-subitems {
            margin-top: 7px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .maintenance-set-entry-subitem {
            border: 1px solid #d6dbe0;
            background: #fff;
            color: #3f4950;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            line-height: 1.25;
            cursor: pointer;
        }
        .maintenance-set-entry-subitem:hover {
            background: #f1f3f5;
            border-color: #c6ccd2;
        }
        .maintenance-set-entry-subitem.selected {
            border-color: var(--primary-color);
            background: #e8f6fa;
            color: #0f5e6e;
        }
        .maintenance-set-entry-meta {
            margin-top: 6px;
            font-size: 12px;
            color: #666;
        }
        .maintenance-set-warnings {
            border: 1px solid #ffe08a;
            background: #fff8df;
            color: #735110;
            border-radius: 5px;
            padding: 8px;
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.35;
        }
        .maintenance-set-actions {
            margin-top: 8px;
            display: flex;
            justify-content: flex-end;
        }

        /* Attachments */
        .attachment-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .attachment-thumb {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .attachment-thumb:active { transform: scale(0.95); }
        .file-upload-btn { display: inline-block; margin-top: 5px; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .modal-content {
            max-width: 100%;
            max-height: 100%;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .modal-close {
            position: absolute;
            top: 20px; right: 20px;
            color: white; font-size: 30px;
            cursor: pointer; z-index: 1001;
        }
        .auth-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(20, 22, 24, 0.45);
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
            padding: 16px;
            box-sizing: border-box;
        }
        .auth-dialog {
            width: 100%;
            max-width: 360px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.22);
            border: 1px solid #e5e5e5;
            padding: 18px;
        }
        .auth-dialog h3 {
            margin: 0 0 8px;
            font-size: 18px;
        }
        .auth-dialog p {
            margin: 0 0 12px;
            color: #555;
            font-size: 14px;
        }
        .auth-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .auth-actions button {
            border: 1px solid #ccc;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 13px;
        }
        .auth-actions button.primary {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: #fff;
        }
        .auth-error {
            margin-top: 8px;
            color: #b02a37;
            font-size: 13px;
            min-height: 16px;
        }
        /* Logo Preview */
        .logo-preview {
            height: 100px;
            width: auto;
            border: 1px dashed #ccc;
            margin-top: 10px;
            display: block;
            object-fit: contain;
        }

        /* App Footer */
        .app-footer {
            text-align: center;
            font-size: 10px;
            color: #ccc;
            margin-top: 10px;
            padding-bottom: 10px;
        }

        /* --- PRINT STYLES --- */
        #print-view { display: none; }

        @media print {
            html, body {
                background: white; margin: 0; padding: 0; height: auto;
                overflow: visible; font-family: Arial, sans-serif; font-size: 12px; color: #000;
            }
            .container {
                box-shadow: none; max-width: 100%; width: 100%;
                padding: 0; margin: 0; border: none; min-height: 0;
            }
            .nav-buttons, .header, .search-bar, #dashboard-view, #config-view, #editor-view, .modal-overlay, .pagination-container, .app-footer, .calendar-day-menu {
                display: none !important;
            }
            #print-view { display: block !important; width: 100%; }

            .print-table { width: 100%; border-collapse: collapse; }
            .print-table thead { display: table-header-group; }
            .print-table tbody { display: table-row-group; }

            .print-header-content {
                display: flex; justify-content: space-between;
                border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-bottom: 10px;
            }
            .print-left-col { width: 60%; }
            .print-title { 
                font-size: 20px; font-weight: bold; color: var(--primary-color); 
                text-transform: uppercase; margin-bottom: 10px; 
            }
            .print-company-row { display: flex; align-items: flex-start; gap: 15px; }
            .print-logo { max-width: 120px; max-height: 70px; object-fit: contain; }
            
            .print-meta { 
                width: 38%; text-align: right; 
                display: grid; grid-template-columns: auto auto;
                gap: 4px 10px; align-content: start; justify-content: end;
            }
            .meta-label { font-weight: bold; text-align: right; }
            .meta-value { text-align: left; white-space: pre-wrap; }

            .vehicle-grid {
                display: grid; grid-template-columns: repeat(3, 1fr);
                gap: 5px; margin-bottom: 15px; border: 1px solid #ccc;
                padding: 10px; background: #f9f9f9;
            }
            .vehicle-item { font-size: 11px; }
            .vehicle-label { font-weight: bold; color: #666; display: block; margin-bottom: 2px; }
            .vehicle-value { font-weight: bold; font-size: 12px; }

            .print-section-title {
                background: #eee; font-weight: bold; padding: 4px 8px;
                margin-top: 10px; border-left: 4px solid var(--primary-color);
                font-size: 11px; text-transform: uppercase;
                page-break-after: avoid;
            }
            
            .print-items-table {
                width: 100%; border-collapse: collapse; margin-bottom: 5px; page-break-inside: auto;
            }
            .print-items-table tr { page-break-inside: avoid; border-bottom: 1px solid #eee; }
            .print-items-table td { padding: 3px 8px; vertical-align: middle; }
            .print-item-name { width: 70%; }
            .print-item-status { width: 30%; text-align: right; font-weight: bold; }

            .status-done { color: #000; }
            .status-not_done { color: #d9534f; }
            .status-na { color: #999; font-style: italic; }

            #print-view.hide-na tr.row-na { display: none; }

            .print-notes {
                border: 1px solid #ccc; padding: 10px; min-height: 50px;
                margin-top: 10px; background: #fff; white-space: pre-wrap;
            }
            .print-notes-container { page-break-inside: avoid; }
            .vehicle-item-full { grid-column: 1 / -1; }
            .vehicle-item-full .vehicle-label {
                display: block;
                margin-bottom: 2px;
            }
            .vehicle-item-full .vehicle-value {
                display: block;
                white-space: pre-wrap;
                font-size: 12px;
                font-weight: bold;
            }

            .print-attachments {
                margin-top: 20px; display: grid;
                grid-template-columns: repeat(2, 1fr); gap: 10px;
            }
            
            /* Logic for page breaks is now handled via JS and .force-break class */
            .force-break {
                page-break-before: always;
            }

            .print-attachments img {
                width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #eee;
            }

            .print-footer-container { margin-top: 20px; page-break-inside: avoid; }
            .print-footer-content {
                border-top: 1px solid #ccc; padding-top: 10px;
                text-align: center; font-size: 10px; color: #666;
            }
            .signature-box {
                margin-top: 30px; border-top: 1px solid #000;
                width: 200px; padding-top: 5px;
                display: inline-block; text-align: left;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1><i class="fas fa-wrench" style="color:var(--primary-color)"></i> Huoltoraportti</h1>
        <div class="nav-buttons">
            <button onclick="showDashboard()">
                <i class="fas fa-list"></i> 
                <span class="btn-text">Raportit</span>
            </button>
            <button onclick="createNewReport()">
                <i class="fas fa-plus"></i> 
                <span class="btn-text">Uusi raportti</span>
                <span class="btn-text-short">Uusi</span>
            </button>
            <button onclick="showConfig()" class="btn-config">
                <i class="fas fa-cog"></i> 
                <span class="btn-text">Asetukset</span>
            </button>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="dashboard-view" class="view active">
        <div class="nav-buttons dashboard-toolbar">
            <button onclick="toggleCalendarMode()" id="btn-calendar-mode">
                <i class="fas fa-calendar-alt"></i>
                <span class="btn-text">Kalenteri</span>
                <span class="btn-text-short">Kalenteri</span>
            </button>
            <div class="dashboard-toolbar-actions">
                <button onclick="toggleSelectionMode()" id="btn-select-mode">
                    <i class="fas fa-check-square"></i>
                    <span class="btn-text">Valitse</span>
                </button>
                <button onclick="deleteSelectedReports()" id="btn-delete-selected" class="danger" style="display:none" disabled>
                    <i class="fas fa-trash"></i>
                    <span class="btn-text">Poista</span>
                </button>
            </div>
        </div>

        <div class="search-bar-wrap">
            <input type="text" class="search-bar" id="search-input" placeholder="Hae rekisterinumerolla, asiakkaalla, ajoneuvolla tai VIN-koodilla..." oninput="handleSearch()">
            <button type="button" id="search-clear-btn" class="search-clear-btn hidden" onclick="clearSearch()" title="Tyhjennä haku" aria-label="Tyhjennä haku">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div id="dashboard-calendar" class="dashboard-calendar">
            <div class="nav-buttons calendar-controls">
                <button onclick="shiftCalendarMonths(-1)">&lt; Edellinen</button>
                <button onclick="jumpCalendarToToday()">Tänään</button>
                <button onclick="shiftCalendarMonths(1)">Seuraava &gt;</button>
            </div>
            <div id="calendar-months" class="calendar-month-grid"></div>
        </div>
        
        <div class="report-list-card">
            <table class="report-list">
                <thead>
                    <tr>
                        <th class="col-select"><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                        <th class="col-date">Pvm</th>
                        <th class="col-customer">Asiakas</th>
                        <th class="col-plate">Rek.nro.</th>
                        <th class="col-vehicle">Ajoneuvo</th>
                    </tr>
                </thead>
                <tbody id="report-table-body">
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
        
        <div class="pagination-container">
            <button class="pagination-btn" id="btn-prev" onclick="changePage(-1)" disabled>&lt; Edellinen</button>
            <span class="pagination-info" id="pagination-info">Sivu 1</span>
            <button class="pagination-btn" id="btn-next" onclick="changePage(1)" disabled>Seuraava &gt;</button>
        </div>

        <div id="calendar-day-menu" class="calendar-day-menu hidden">
            <div id="calendar-day-menu-title" class="calendar-day-menu-title"></div>
            <div id="calendar-day-menu-list" class="calendar-day-menu-list"></div>
            <button id="calendar-day-menu-create" class="calendar-day-menu-create" onclick="createNewReportFromCalendarDay()">
                <i class="fas fa-plus"></i>
                <span>Uusi raportti</span>
            </button>
        </div>
    </div>

    <!-- EDITOR VIEW -->
    <div id="editor-view" class="view">
        <div class="nav-buttons" style="margin-bottom: 20px; text-align: right;">
            <button class="report-save-btn" onclick="saveReport()"><i class="fas fa-save"></i> Tallenna</button>
            <button class="primary" onclick="preparePrint()"><i class="fas fa-print"></i> Tulosta</button>
        </div>

        <form id="report-form">
            <input type="hidden" id="report-id">
            
            <!-- Company & Customer -->
            <div class="document-section">
                <div class="document-section-header">Yleistiedot</div>
                <div class="document-section-content">
                    <div class="form-row general-info-row">
                        <div class="form-group">
                            <label>Asiakas</label>
                            <textarea class="form-control" id="customer_name" rows="4" placeholder="Asiakkaan nimi ja osoite..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Huoltopäivä</label>
                            <input type="date" class="form-control" id="report_date">
                        </div>
                        <div class="form-group preinfo-group">
                            <label>Esitiedot</label>
                            <textarea class="form-control preinfo-input" id="pre_info" rows="4" placeholder=""></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Info -->
            <div class="document-section">
                <div class="document-section-header">Ajoneuvon tiedot</div>
                <div class="document-section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Rekisterinumero</label>
                            <input type="text" class="form-control" id="license_plate" onblur="lookupVehicle()">
                        </div>
                        <div class="form-group">
                            <label>Valmistenumero (VIN)</label>
                            <input type="text" class="form-control" id="vin">
                        </div>
                        <div class="form-group">
                            <label>Ajoneuvo (Merkki & Malli)</label>
                            <input type="text" class="form-control" id="vehicle_model">
                        </div>
                        <div class="form-group">
                            <label>Moottorikoodi</label>
                            <input type="text" class="form-control" id="engine_code">
                        </div>
                        <div class="form-group">
                            <label>Rekisteröity</label>
                            <input type="text" class="form-control" id="registered_date">
                        </div>
                        <div class="form-group">
                            <label>Ajettu (km)</label>
                            <input type="number" class="form-control" id="mileage">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Maintenance Items -->
            <div id="report-update-banner" class="report-update-banner" style="display:none;">
                <p>Asetuksissa määritellyt huoltotoimenpiteet ovat päivittyneet tämän raportin tallennuksen jälkeen. Voit halutessasi päivittää raportin vastaamaan nykyasetuksia, jolloin jotkin kohdat muuttuvat tai poistuvat. Poistuneille kohteille on mahdollista etsiä uudet vastineet.</p>
                <div class="report-update-actions">
                    <button type="button" onclick="updateReportTemplateToCurrentSettings()">Päivitä</button>
                </div>
            </div>
			
			<!-- Maintenance sets -->
            <div id="maintenance-sets-section" class="document-section" style="display:none;">
                <div class="document-section-header">Huoltosetit</div>
                <div class="document-section-content">
                    <div id="maintenance-sets-container" class="maintenance-set-chips"></div>
                </div>
            </div>
			
			<!-- Maintenance titles and items -->
            <div id="maintenance-sections-container"></div>

            <!-- Additional Work -->
            <div class="document-section">
                <div class="document-section-header">Lisätyöt ja huomiot</div>
                <div class="document-section-content">
                    <div class="form-group">
                        <textarea class="form-control" id="additional_notes" rows="4" placeholder="Kirjoita lisätyöt tähän..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Attachments -->
            <div class="document-section">
                <div class="document-section-header">Liitteet</div>
                <div class="document-section-content">
                    <div class="form-group">
                        <label>Lisää kuvia:</label>
                        <input type="file" id="file-upload" class="file-upload-btn" accept="image/*" onchange="uploadFile(this)">
                        <div id="attachment-list" class="attachment-list"></div>
                        <p style="font-size: 12px; color: #666; margin-top:10;">Nämä tulostuvat raportin loppuun. Napauta kuvaa suurentaaksesi, pitkä painallus poistaa kuvan.</p>
                    </div>
                </div>
            </div>

            <!-- Signature -->
            <div class="document-section">
                <div class="document-section-header">Allekirjoitus</div>
                <div class="document-section-content">
                    <div class="form-group">
                        <label>Huollon suorittaja</label>
                        <input type="text" class="form-control" id="mechanic_signature">
                    </div>
                </div>
            </div>

            <div class="nav-buttons" style="margin-top: 20px; text-align: right;">
                <button type="button" class="report-save-btn" onclick="saveReport()"><i class="fas fa-save"></i> Tallenna</button>
                <button type="button" class="primary" onclick="preparePrint()"><i class="fas fa-print"></i> Tulosta</button>
            </div>
        </form>
    </div>

    <!-- CONFIG VIEW -->
    <div id="config-view" class="view">
        <div class="nav-buttons" style="margin-bottom: 20px; text-align: right;">
            <button type="button" class="config-save-btn" onclick="saveConfig()"><i class="fas fa-save"></i> Tallenna</button>
        </div>

        <div class="document-section">
            <div class="document-section-header">Yleiset asetukset</div>
            <div class="document-section-content">
                <div class="form-group">
                    <label>Yrityksen logo</label>
                    <input type="file" accept="image/*" onchange="uploadLogo(this)">
                    <img id="conf_logo_preview" src="" class="logo-preview" style="display:none">
                    <button id="btn_delete_logo" onclick="deleteLogo()" style="margin-top:5px; display:none; padding:5px 10px; background:#ddd; border:none; border-radius:4px; cursor:pointer;">Poista logo</button>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label for="conf_accent_color">Korostusväri</label>
                    <input type="color" id="conf_accent_color" class="form-control" style="max-width: 140px; padding: 6px; height: 44px;">
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
                <div class="form-group">
                    <label>Yrityksen tiedot</label>
                    <textarea class="form-control" id="conf_company_text" rows="4"></textarea>
                </div>
                <div style="margin-top:15px">
                    <input type="checkbox" id="conf_hide_na">
                    <label for="conf_hide_na">Piilota "Ei sisälly" -kohdat tulosteesta oletuksena</label>
                </div>
            </div>
        </div>

        <div class="document-section">
            <div class="document-section-header">Tietoturva</div>
            <div class="document-section-content">
                <div>
                    <input type="checkbox" id="conf_use_password">
                    <label for="conf_use_password">Käytä salasanaa kirjautumiseen</label>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label for="conf_api_password" id="conf_password_label">Aseta salasana</label>
                    <input type="password" class="form-control" id="conf_api_password" autocomplete="new-password" placeholder="Anna salasana">
                </div>
                <p class="config-help" style="margin-top: 12px;">Kun salasana on käytössä, sitä kysytään kaikilta uusilta laitteilta ennen sovellukseen pääsyä. Kirjautuminen muistetaan selaimen evästeellä. Asettaessa tai poistaessa salasanaa, muista tallentaa asetukset. Unohtuneen salasanan voi nollata palvelimen kansiossa: <kbd>python3 resetpw.py</kbd></p>
            </div>
        </div>

        <div class="document-section">
            <div class="document-section-header">Muokkaa huoltokohteita</div>
            <div class="document-section-content">
                <p class="config-help">Voit lisätä, nimetä uudelleen, järjestellä ja poistaa otsikoita tai kohteita. Tallennettujen raporttien alkuperäinen rakenne säilyy raportissa, joten vanhat raportit pysyvät tulostettavina myös asetusten muutosten jälkeen. Muuttuneet asetukset on päivitettävissä aiemmin tallennettuihin raportteihin, jolloin nimitykset, alikohdat ja järjestys päivittyvät. Kohteet jotka olivat raportilla aiemmin, mutta joita ei enää ole asetuksissa, löytyvät "Poistuneet huoltotoimenpiteet" -listasta kunnes etsit niille vastineen tai poistat ne raportilta.</p>
                <div class="config-editor">
                    <div class="config-actions">
                        <button type="button" class="cfg-btn" onclick="addConfigGroup()"><i class="fas fa-plus"></i> Lisää otsikko</button>
                    </div>
                    <div id="config-groups" class="config-groups"></div>
                    <details class="config-json-details">
                        <summary>Näytä / muokkaa raaka JSON</summary>
                        <textarea id="config-json" class="config-json-preview" spellcheck="false"></textarea>
                    </details>
                    <div style="margin-top: 14px;">
                        <h4 style="margin: 0 0 10px;">Huoltokohteiden tilat</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="conf_status_done">Suoritettu-tila</label>
                                <input type="text" class="form-control" id="conf_status_done">
                            </div>
                            <div class="form-group">
                                <label for="conf_status_not_done">Ei tehty -tila</label>
                                <input type="text" class="form-control" id="conf_status_not_done">
                            </div>
                            <div class="form-group">
                                <label for="conf_status_na">Ei sisälly -tila</label>
                                <input type="text" class="form-control" id="conf_status_na">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="document-section">
            <div class="document-section-header">Huoltosettien luonti</div>
            <div class="document-section-content">
                <p class="config-help">Luo huoltosettejä valitsemalla huoltokohteet, niille tilat ja alakohtia. Raportissa voit ottaa setin käyttöön yhdellä napautuksella.</p>
                <div class="maintenance-set-create-row">
                    <input type="text" class="form-control" id="new-maintenance-set-name" placeholder="Huoltosetin nimi">
                    <button type="button" class="cfg-btn" onclick="addMaintenanceSetFromInput()"><i class="fas fa-plus"></i> Luo huoltosetti</button>
                </div>
                <div id="maintenance-set-editor" class="maintenance-set-list"></div>
            </div>
        </div>

        <div class="nav-buttons" style="margin-top: 20px; text-align: right;">
            <button type="button" class="config-save-btn" onclick="saveConfig()"><i class="fas fa-save"></i> Tallenna</button>
        </div>
    </div>

</div>

<!-- Footer (Outside Container) -->
<div class="app-footer">v1.2 | Makkesoft 2026 | AGPLv3</div>

<!-- Image Modal -->
<div id="image-modal" class="modal-overlay" onclick="closeImageModal()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modal-img-element">
</div>

<div id="auth-overlay" class="auth-overlay">
    <div class="auth-dialog">
        <h3>Salasana vaaditaan</h3>
        <p>Sovellus on suojattu salasanalla. Anna salasana jatkaaksesi.</p>
        <input type="password" id="auth-password-input" class="form-control" autocomplete="current-password" placeholder="Salasana">
        <div id="auth-error" class="auth-error"></div>
        <div class="auth-actions">
            <button type="button" class="primary" onclick="submitAuthPassword()"><i class="fas fa-unlock"></i> Avaa</button>
        </div>
    </div>
</div>

<!-- PRINT VIEW -->
<div id="print-view">
    <table class="print-table">
        <thead>
            <tr>
                <td>
                    <div class="print-header-content">
                        <div class="print-left-col">
                            <div class="print-title">Huoltoraportti</div>
                            <div class="print-company-row">
                                <img id="p_logo_img" class="print-logo" style="display:none">
                                <div id="p_company" style="white-space: pre-wrap;"></div>
                            </div>
                        </div>
                        
                        <div class="print-meta">
                            <div class="meta-label" style="margin-top: 26px;">Pvm:</div>
                            <div class="meta-value" id="p_date" style="margin-top: 26px;"></div>
                            <div class="meta-label">Asiakas:</div>
                            <div class="meta-value" id="p_customer"></div>
                        </div>
                    </div>
                </td>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <!-- Vehicle Info -->
                    <div class="vehicle-grid">
                        <div class="vehicle-item"><span class="vehicle-label">Rekisterinumero</span><span class="vehicle-value" id="p_plate"></span></div>
                        <div class="vehicle-item"><span class="vehicle-label">Ajoneuvo</span><span class="vehicle-value" id="p_model"></span></div>
                        <div class="vehicle-item"><span class="vehicle-label">Ajettu (km)</span><span class="vehicle-value" id="p_mileage"></span></div>
                        <div class="vehicle-item"><span class="vehicle-label">VIN</span><span class="vehicle-value" id="p_vin"></span></div>
                        <div class="vehicle-item"><span class="vehicle-label">Moottorikoodi</span><span class="vehicle-value" id="p_engine"></span></div>
                        <div class="vehicle-item"><span class="vehicle-label">Ensirekisteröinti</span><span class="vehicle-value" id="p_regdate"></span></div>
                        <div id="p_preinfo_row" class="vehicle-item vehicle-item-full" style="display:none;"><span class="vehicle-label">Esitiedot</span><span class="vehicle-value" id="p_preinfo"></span></div>
                    </div>

                    <div id="p_maintenance_content"></div>

                    <div id="p_notes_container" class="print-notes-container">
                        <div class="print-section-title">Lisätyöt ja huomiot</div>
                        <div class="print-notes" id="p_notes"></div>
                    </div>

                    <!-- Signature (Moved before Attachments) -->
                    <div class="print-footer-container">
                        <div class="print-footer-content">
                            Kiitos käynnistä! Tervetuloa uudelleen.
                            <br>
                            <div class="signature-box">
                                Allekirjoitus: <span id="p_signature"></span>
                            </div>
                        </div>
                    </div>

                    <div id="p_attachments_container" style="display:none">
                        <div class="print-section-title">Liitteet</div>
                        <div class="print-attachments" id="p_attachments"></div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    // State
    const MAINTENANCE_SCHEMA_VERSION = 2;
    const LEGACY_REPLACEMENT_HELP_TEXT = 'Voit valita raportin alkuperäisestä versiosta poistuneille kohteille uudet vastineet alla:';
    const DEFAULT_STATUS_TEXTS = {
        'done': 'Suoritettu',
        'not_done': 'Ei tehty',
        'na': 'Ei sisälly'
    };
    const statusTexts = { ...DEFAULT_STATUS_TEXTS };
    const DEFAULT_ACCENT_COLOR = '#009eb8';
    const STATIC_LOGO_ID = 'company_logo';
    const CALENDAR_WEEKDAY_LABELS = ['Ma', 'Ti', 'Ke', 'To', 'Pe', 'La', 'Su'];
    const CALENDAR_MONTH_LABEL_FORMATTER = new Intl.DateTimeFormat('fi-FI', { month: 'long', year: 'numeric' });
    const CALENDAR_DAY_LABEL_FORMATTER = new Intl.DateTimeFormat('fi-FI', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });

    let currentConfig = { maintenance_items: {}, maintenance_sets: {}, shop_settings: {}, security: {} };
    let currentAttachments = [];
    let currentPage = 1;
    let itemsPerPage = 15;
    let totalItems = 0;
    let isSelectionMode = false;
    let searchTimeout = null;
    let configEditorState = { groups: [] };
    let maintenanceSetEditorState = { sets: [] };
    let maintenanceSetExpandedIds = new Set();
    let configDragState = null;
    let currentReportMaintenance = { schema_version: MAINTENANCE_SCHEMA_VERSION, groups: [], legacy_items: [] };
    let currentReportHasSettingsMismatch = false;
    let currentReportLoadedFromLegacyFormat = false;
    let isReportDirty = false;
    let reportDirtyTrackingPaused = false;
    let lastSavedReportSnapshot = '';
    let isConfigDirty = false;
    let configDirtyTrackingPaused = false;
    let lastSavedConfigSnapshot = '';
    let pendingAuthPromise = null;
    let authDialogResolver = null;
    let authLockUntilMs = 0;
    let authLockTimerId = null;
    let isCalendarMode = false;
    let calendarStartMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
    let calendarReportsByDate = {};
    let calendarLoadedRange = { start: '', end: '' };
    let calendarMenuDate = '';

    function showAuthDialog() {
        const overlay = document.getElementById('auth-overlay');
        const error = document.getElementById('auth-error');
        const input = document.getElementById('auth-password-input');
        if (!overlay || !input || !error) return;
        error.textContent = '';
        input.value = '';
        overlay.style.display = 'flex';
        setAuthDialogBusy(false);
        if (applyAuthDialogLockState()) return;
        setTimeout(() => input.focus(), 0);
    }

    function hideAuthDialog() {
        const overlay = document.getElementById('auth-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    function setAuthDialogBusy(isBusy) {
        const input = document.getElementById('auth-password-input');
        const button = document.querySelector('#auth-overlay button');
        if (input) input.disabled = !!isBusy;
        if (button) button.disabled = !!isBusy;
    }

    function getAuthLockRemainingSeconds() {
        return Math.max(0, Math.ceil((authLockUntilMs - Date.now()) / 1000));
    }

    function clearAuthLockTimer() {
        if (authLockTimerId) {
            clearTimeout(authLockTimerId);
            authLockTimerId = null;
        }
    }

    function applyAuthDialogLockState() {
        const error = document.getElementById('auth-error');
        const remainingSeconds = getAuthLockRemainingSeconds();
        clearAuthLockTimer();
        if (remainingSeconds <= 0) {
            authLockUntilMs = 0;
            return false;
        }
        setAuthDialogBusy(true);
        if (error) error.textContent = 'Liian monta väärää yritystä, yritä myöhemmin uudelleen.';
        authLockTimerId = setTimeout(() => {
            applyAuthDialogLockState();
            if (getAuthLockRemainingSeconds() <= 0) setAuthDialogBusy(false);
        }, (remainingSeconds * 1000) + 50);
        return true;
    }

    function resolveAuthDialog(success) {
        if (typeof authDialogResolver === 'function') {
            authDialogResolver(!!success);
        }
        authDialogResolver = null;
        hideAuthDialog();
    }

    async function submitAuthPassword() {
        const input = document.getElementById('auth-password-input');
        const error = document.getElementById('auth-error');
        if (!input || !error) return;
        if (applyAuthDialogLockState()) return;
        const password = input.value || '';
        if (!password.trim()) {
            error.textContent = 'Anna salasana.';
            input.focus();
            return;
        }

        setAuthDialogBusy(true);
        error.textContent = '';

        try {
            const res = await fetch('api/auth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: password })
            });
            const data = await res.json();
            if (res.ok && (data.status === 'ok' || data.status === 'not_required')) {
                authLockUntilMs = 0;
                clearAuthLockTimer();
                resolveAuthDialog(true);
                return;
            }
            if (res.status === 429) {
                const retryAfterRaw = Number(data && data.retry_after);
                const retryAfterSeconds = Number.isFinite(retryAfterRaw) && retryAfterRaw > 0 ? Math.ceil(retryAfterRaw) : 60;
                authLockUntilMs = Date.now() + (retryAfterSeconds * 1000);
                applyAuthDialogLockState();
                return;
            }
            error.textContent = 'Salasana oli virheellinen.';
            setAuthDialogBusy(false);
            input.focus();
            input.select();
        } catch (e) {
            error.textContent = 'Yhteysvirhe palvelimeen.';
            setAuthDialogBusy(false);
        }
    }

    function ensureApiAuth() {
        if (pendingAuthPromise) return pendingAuthPromise;
        pendingAuthPromise = new Promise(resolve => {
            authDialogResolver = resolve;
            showAuthDialog();
        }).finally(() => {
            pendingAuthPromise = null;
        });
        return pendingAuthPromise;
    }

    async function apiFetch(resource, options = {}, retryCount = 0) {
        const res = await fetch(resource, options);
        if (res.status !== 403) return res;

        let payload = null;
        try {
            payload = await res.clone().json();
        } catch (e) {
            payload = null;
        }
        if (!payload || !payload.auth_required) return res;

        const authOk = await ensureApiAuth();
        if (!authOk || retryCount >= 1) return res;
        return apiFetch(resource, options, retryCount + 1);
    }

    function updateSecurityPasswordInputState() {
        const usePasswordCheckbox = document.getElementById('conf_use_password');
        const passwordInput = document.getElementById('conf_api_password');
        if (!usePasswordCheckbox || !passwordInput) return;
        passwordInput.disabled = !usePasswordCheckbox.checked;
        if (!usePasswordCheckbox.checked) {
            passwordInput.value = '';
        }
    }

    function nextId(prefix) {
        const hasCryptoUuid = typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function';
        if (hasCryptoUuid) return `${prefix}_${crypto.randomUUID()}`;
        return `${prefix}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 10)}`;
    }

    function nextConfigGroupId() { return nextId('group'); }
    function nextConfigItemId() { return nextId('item'); }
    function nextMaintenanceSetId() { return nextId('set'); }
    function nextLegacyItemId() { return nextId('legacy'); }

    function normalizeIsoDate(value) {
        const trimmed = (typeof value === 'string') ? value.trim() : '';
        return /^\d{4}-\d{2}-\d{2}$/.test(trimmed) ? trimmed : '';
    }

    function parseIsoDate(value) {
        const normalized = normalizeIsoDate(value);
        if (!normalized) return null;
        const [year, month, day] = normalized.split('-').map(num => parseInt(num, 10));
        return new Date(year, month - 1, day);
    }

    function formatIsoDate(date) {
        if (!(date instanceof Date)) return '';
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function getMonthStart(date) {
        return new Date(date.getFullYear(), date.getMonth(), 1);
    }

    function getMonthEnd(date) {
        return new Date(date.getFullYear(), date.getMonth() + 1, 0);
    }

    function addMonths(date, count) {
        return new Date(date.getFullYear(), date.getMonth() + count, 1);
    }

    function capitalizeFirst(text) {
        if (!text) return '';
        return text.charAt(0).toUpperCase() + text.slice(1);
    }

    function formatCalendarMonthLabel(date) {
        return capitalizeFirst(CALENDAR_MONTH_LABEL_FORMATTER.format(date));
    }

    function formatCalendarDayLabel(dateIso) {
        const parsed = parseIsoDate(dateIso);
        if (!parsed) return dateIso;
        return capitalizeFirst(CALENDAR_DAY_LABEL_FORMATTER.format(parsed));
    }

    function normalizeStatus(status) {
        return Object.prototype.hasOwnProperty.call(statusTexts, status) ? status : 'na';
    }

    function normalizeStatusLabelText(value, fallback) {
        const normalized = (typeof value === 'string') ? value.trim() : '';
        return normalized || fallback;
    }

    function normalizeStatusLabels(labels) {
        const source = (labels && typeof labels === 'object') ? labels : {};
        return {
            done: normalizeStatusLabelText(source.done, DEFAULT_STATUS_TEXTS.done),
            not_done: normalizeStatusLabelText(source.not_done, DEFAULT_STATUS_TEXTS.not_done),
            na: normalizeStatusLabelText(source.na, DEFAULT_STATUS_TEXTS.na)
        };
    }

    function applyStatusLabels(labels) {
        const normalized = normalizeStatusLabels(labels);
        statusTexts.done = normalized.done;
        statusTexts.not_done = normalized.not_done;
        statusTexts.na = normalized.na;
        return normalized;
    }

    function normalizeAccentColor(color) {
        const value = (typeof color === 'string') ? color.trim() : '';
        return /^#[0-9a-fA-F]{6}$/.test(value) ? value.toLowerCase() : DEFAULT_ACCENT_COLOR;
    }

    function applyAccentColor(color) {
        document.documentElement.style.setProperty('--primary-color', normalizeAccentColor(color));
    }

    function setReportDirty(nextValue) {
        isReportDirty = !!nextValue;
        document.querySelectorAll('.report-save-btn').forEach(btn => {
            btn.classList.toggle('unsaved', isReportDirty);
        });
    }

    function setConfigDirty(nextValue) {
        isConfigDirty = !!nextValue;
        document.querySelectorAll('.config-save-btn').forEach(btn => {
            btn.classList.toggle('unsaved', isConfigDirty);
        });
    }

    function withDirtyTrackingPaused(fn) {
        const prev = reportDirtyTrackingPaused;
        reportDirtyTrackingPaused = true;
        try {
            return fn();
        } finally {
            reportDirtyTrackingPaused = prev;
        }
    }

    function withConfigDirtyTrackingPaused(fn) {
        const prev = configDirtyTrackingPaused;
        configDirtyTrackingPaused = true;
        try {
            return fn();
        } finally {
            configDirtyTrackingPaused = prev;
        }
    }

    function buildReportPayloadFromEditor() {
        const maintenanceV2 = collectMaintenanceV2ForSave();
        currentReportMaintenance = maintenanceV2;
        return {
            id: document.getElementById('report-id').value,
            customer_name: document.getElementById('customer_name').value,
            report_date: document.getElementById('report_date').value,
            pre_info: document.getElementById('pre_info').value,
            license_plate: document.getElementById('license_plate').value,
            vin: document.getElementById('vin').value,
            vehicle_model: document.getElementById('vehicle_model').value,
            engine_code: document.getElementById('engine_code').value,
            registered_date: document.getElementById('registered_date').value,
            mileage: document.getElementById('mileage').value,
            additional_notes: document.getElementById('additional_notes').value,
            mechanic_signature: document.getElementById('mechanic_signature').value,
            maintenance_schema_version: MAINTENANCE_SCHEMA_VERSION,
            maintenance_v2: maintenanceV2,
            items: flattenMaintenanceItems(maintenanceV2),
            attachments: [...currentAttachments]
        };
    }

    function getCurrentReportSnapshot() {
        return JSON.stringify(buildReportPayloadFromEditor());
    }

    function markCurrentReportAsSaved() {
        lastSavedReportSnapshot = getCurrentReportSnapshot();
        setReportDirty(false);
    }

    function getCurrentConfigSnapshot() {
        const configJsonInput = document.getElementById('config-json');
        const rawConfigJson = configJsonInput ? configJsonInput.value : '';
        let maintenanceItems = null;
        let maintenanceJsonState = 'valid';
        try {
            maintenanceItems = normalizeMaintenanceConfig(JSON.parse(rawConfigJson)).value;
        } catch (e) {
            maintenanceJsonState = `invalid:${rawConfigJson}`;
            maintenanceItems = getMaintenanceItemsFromEditor();
        }

        const maintenanceSets = getMaintenanceSetsFromEditor(maintenanceItems);
        const statusLabels = normalizeStatusLabels({
            done: document.getElementById('conf_status_done') ? document.getElementById('conf_status_done').value : '',
            not_done: document.getElementById('conf_status_not_done') ? document.getElementById('conf_status_not_done').value : '',
            na: document.getElementById('conf_status_na') ? document.getElementById('conf_status_na').value : ''
        });
        const shopSettings = {
            company_text: document.getElementById('conf_company_text') ? document.getElementById('conf_company_text').value : '',
            hide_na_in_print: !!(document.getElementById('conf_hide_na') && document.getElementById('conf_hide_na').checked),
            accent_color: normalizeAccentColor(document.getElementById('conf_accent_color') ? document.getElementById('conf_accent_color').value : ''),
            status_labels: statusLabels
        };
        const usePassword = !!(document.getElementById('conf_use_password') && document.getElementById('conf_use_password').checked);
        const newPassword = document.getElementById('conf_api_password') ? (document.getElementById('conf_api_password').value || '') : '';
        return JSON.stringify({
            maintenance_items: maintenanceItems,
            maintenance_items_json_state: maintenanceJsonState,
            maintenance_sets: maintenanceSets,
            shop_settings: shopSettings,
            security_ui: {
                use_password: usePassword,
                new_password: newPassword
            },
            security_state: {
                password_enabled: !!(currentConfig.security && currentConfig.security.password_enabled)
            }
        });
    }

    function markCurrentConfigAsSaved() {
        lastSavedConfigSnapshot = getCurrentConfigSnapshot();
        setConfigDirty(false);
    }

    function evaluateReportDirtyState() {
        if (reportDirtyTrackingPaused) return;
        if (!lastSavedReportSnapshot) {
            setReportDirty(false);
            return;
        }
        setReportDirty(getCurrentReportSnapshot() !== lastSavedReportSnapshot);
    }

    function evaluateConfigDirtyState() {
        if (configDirtyTrackingPaused) return;
        if (!lastSavedConfigSnapshot) {
            setConfigDirty(false);
            return;
        }
        setConfigDirty(getCurrentConfigSnapshot() !== lastSavedConfigSnapshot);
    }

    function isEditorViewActive() {
        const editorView = document.getElementById('editor-view');
        return !!editorView && editorView.classList.contains('active');
    }

    function isConfigViewActive() {
        const configView = document.getElementById('config-view');
        return !!configView && configView.classList.contains('active');
    }

    function handleGlobalShortcuts(event) {
        const key = (event.key || '').toLowerCase();
        const isPrimaryModifier = event.ctrlKey || event.metaKey;
        if (!isPrimaryModifier || event.altKey || event.shiftKey || event.repeat) return;

        if (key === 's') {
            if (isEditorViewActive()) {
                event.preventDefault();
                saveReport();
                return;
            }
            if (isConfigViewActive()) {
                event.preventDefault();
                saveConfig();
            }
            return;
        }

        if (key === 'p' && isEditorViewActive()) {
            event.preventDefault();
            preparePrint();
        }
    }

    function confirmDiscardUnsavedReportChanges(targetLabel) {
        if (!isEditorViewActive() || !isReportDirty) return true;
        const ok = confirm(`Raportissa on tallentamattomia muutoksia. Siirrytäänkö näkymään "${targetLabel}" ilman tallennusta?`);
        if (ok) {
            markCurrentReportAsSaved();
        }
        return ok;
    }

    function confirmDiscardUnsavedConfigChanges(targetLabel) {
        if (!isConfigViewActive() || !isConfigDirty) return true;
        const ok = confirm(`Asetuksissa on tallentamattomia muutoksia. Siirrytäänkö näkymään "${targetLabel}" ilman tallennusta?`);
        if (ok) {
            markCurrentConfigAsSaved();
        }
        return ok;
    }

    function initReportDirtyTracking() {
        const form = document.getElementById('report-form');
        if (form) {
            form.addEventListener('input', evaluateReportDirtyState);
            form.addEventListener('change', evaluateReportDirtyState);
        }
        window.addEventListener('beforeunload', event => {
            if (!isReportDirty && !isConfigDirty) return;
            event.preventDefault();
            event.returnValue = '';
        });
    }

    function initConfigDirtyTracking() {
        const view = document.getElementById('config-view');
        if (!view) return;
        view.addEventListener('input', evaluateConfigDirtyState);
        view.addEventListener('change', evaluateConfigDirtyState);
    }

    function escapeHtml(value) {
        return String(value || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function normalizeSubitems(rawSubitems) {
        const source = Array.isArray(rawSubitems) ? rawSubitems : [];
        return source
            .map(value => (typeof value === 'string' ? value.trim() : ''))
            .filter(value => value.length > 0);
    }

    function normalizeSelectedSubitems(rawSelectedSubitems, availableSubitems) {
        const available = normalizeSubitems(availableSubitems);
        const selectedSet = new Set(normalizeSubitems(rawSelectedSubitems));
        return available.filter(value => selectedSet.has(value));
    }

    function normalizeMaintenanceNote(note) {
        return (typeof note === 'string') ? note.trim() : '';
    }

    function getStatusInputForItemElement(el) {
        return el ? el.querySelector('input[type="hidden"][data-role="status"]') : null;
    }

    function getNoteInputForItemElement(el) {
        return el ? el.querySelector('.maintenance-note-input') : null;
    }

    function getMaintenanceItemExtraDetails(item) {
        const extras = normalizeSelectedSubitems(item && item.selected_subitems, item && item.subitems);
        const note = normalizeMaintenanceNote(item && item.note);
        if (note) extras.push(note.replace(/\s+/g, ' ').trim());
        return extras;
    }

    function formatMaintenanceItemLabelForPrint(item, suffix = '') {
        const baseLabel = (item && typeof item.label === 'string') ? item.label.trim() : '';
        const extras = getMaintenanceItemExtraDetails(item);
        const extrasText = extras.length > 0 ? `: ${extras.join(', ')}` : '';
        return `${baseLabel}${suffix}${extrasText}`;
    }

    function buildMaintenanceItemLookup(maintenanceItems) {
        const source = (maintenanceItems && typeof maintenanceItems === 'object') ? maintenanceItems : {};
        const groups = Array.isArray(source.groups) ? source.groups : [];
        const byId = new Map();
        const ordered = [];
        groups.forEach(group => {
            const groupTitle = (group && typeof group.title === 'string') ? group.title.trim() : '';
            (Array.isArray(group && group.items) ? group.items : []).forEach(item => {
                const itemId = (item && typeof item.id === 'string') ? item.id.trim() : '';
                if (!itemId || byId.has(itemId)) return;
                const label = (item && typeof item.label === 'string') ? item.label.trim() : '';
                const entry = {
                    id: itemId,
                    label: label,
                    group_title: groupTitle,
                    subitems: normalizeSubitems(item && item.subitems)
                };
                byId.set(itemId, entry);
                ordered.push(entry);
            });
        });
        return { byId: byId, ordered: ordered };
    }

    function normalizeMaintenanceSets(rawSets, maintenanceItems) {
        const source = (rawSets && typeof rawSets === 'object') ? rawSets : {};
        const sourceSets = Array.isArray(rawSets)
            ? rawSets
            : (Array.isArray(source.sets) ? source.sets : []);
        const normalized = { sets: [] };
        const itemLookup = buildMaintenanceItemLookup(maintenanceItems || currentConfig.maintenance_items || {}).byId;
        const seenSetIds = new Set();
        let changed = Array.isArray(rawSets) || !Array.isArray(source.sets);

        sourceSets.forEach(rawSet => {
            if (!rawSet || typeof rawSet !== 'object') {
                changed = true;
                return;
            }
            let setId = (typeof rawSet.id === 'string') ? rawSet.id.trim() : '';
            if (!setId || seenSetIds.has(setId)) {
                setId = nextMaintenanceSetId();
                changed = true;
            }
            seenSetIds.add(setId);
            const name = (typeof rawSet.name === 'string') ? rawSet.name.trim() : '';
            if (typeof rawSet.name !== 'string') changed = true;

            const rawEntries = Array.isArray(rawSet.entries) ? rawSet.entries : [];
            if (!Array.isArray(rawSet.entries)) changed = true;
            const entries = [];
            const seenItemIds = new Set();
            rawEntries.forEach(rawEntry => {
                if (!rawEntry || typeof rawEntry !== 'object') {
                    changed = true;
                    return;
                }
                const itemId = (typeof rawEntry.item_id === 'string') ? rawEntry.item_id.trim() : '';
                if (!itemId || seenItemIds.has(itemId)) {
                    changed = true;
                    return;
                }
                seenItemIds.add(itemId);
                const status = normalizeStatus(rawEntry.status);
                if (status !== rawEntry.status) changed = true;
                const itemRef = itemLookup.get(itemId);
                let itemLabel = (typeof rawEntry.item_label === 'string') ? rawEntry.item_label.trim() : '';
                if (!itemLabel && itemRef && itemRef.label) {
                    itemLabel = itemRef.label;
                    if (typeof rawEntry.item_label !== 'string') changed = true;
                }
                const selectedSubitems = normalizeSubitems(rawEntry.selected_subitems);
                const normalizedSelectedSubitems = itemRef
                    ? normalizeSelectedSubitems(selectedSubitems, itemRef.subitems)
                    : selectedSubitems;
                if (normalizedSelectedSubitems.length !== selectedSubitems.length) changed = true;

                entries.push({
                    item_id: itemId,
                    item_label: itemLabel,
                    status: status,
                    selected_subitems: normalizedSelectedSubitems
                });
            });

            normalized.sets.push({ id: setId, name: name, entries: entries });
        });

        return { value: normalized, changed: changed };
    }

    function normalizeMaintenanceConfig(maintenanceItems) {
        const source = (maintenanceItems && typeof maintenanceItems === 'object') ? maintenanceItems : {};
        const groups = Array.isArray(source.groups) ? source.groups : [];
        const normalized = { schema_version: MAINTENANCE_SCHEMA_VERSION, groups: [] };
        const seenGroupIds = new Set();
        const seenItemIds = new Set();
        let changed = source.schema_version !== MAINTENANCE_SCHEMA_VERSION || !Array.isArray(source.groups);

        groups.forEach(rawGroup => {
            if (!rawGroup || typeof rawGroup !== 'object') {
                changed = true;
                return;
            }

            let groupId = (typeof rawGroup.id === 'string' ? rawGroup.id.trim() : '');
            if (!groupId || seenGroupIds.has(groupId)) {
                groupId = nextConfigGroupId();
                changed = true;
            }
            seenGroupIds.add(groupId);

            const title = typeof rawGroup.title === 'string' ? rawGroup.title : '';
            if (typeof rawGroup.title !== 'string') changed = true;

            const rawItems = Array.isArray(rawGroup.items) ? rawGroup.items : [];
            if (!Array.isArray(rawGroup.items)) changed = true;

            const items = [];
            rawItems.forEach(rawItem => {
                let itemId = '';
                let label = '';
                let subitems = [];

                if (typeof rawItem === 'string') {
                    label = rawItem;
                    changed = true;
                } else if (rawItem && typeof rawItem === 'object') {
                    itemId = (typeof rawItem.id === 'string') ? rawItem.id.trim() : '';
                    label = (typeof rawItem.label === 'string')
                        ? rawItem.label
                        : ((typeof rawItem.name === 'string') ? rawItem.name : '');
                    if (typeof rawItem.label !== 'string') changed = true;
                    if (Object.prototype.hasOwnProperty.call(rawItem, 'subitems')) {
                        if (Array.isArray(rawItem.subitems)) {
                            const rawSubitems = rawItem.subitems;
                            subitems = normalizeSubitems(rawSubitems);
                            if (subitems.length !== rawSubitems.length) changed = true;
                            if (!changed && rawSubitems.some((entry, index) => typeof entry !== 'string' || entry.trim() !== subitems[index])) {
                                changed = true;
                            }
                        } else {
                            changed = true;
                        }
                    }
                } else {
                    changed = true;
                    return;
                }

                if (!itemId || seenItemIds.has(itemId)) {
                    itemId = nextConfigItemId();
                    changed = true;
                }
                seenItemIds.add(itemId);
                const normalizedItem = { id: itemId, label: label };
                if (subitems.length > 0) normalizedItem.subitems = subitems;
                items.push(normalizedItem);
            });

            normalized.groups.push({ id: groupId, title: title, items: items });
        });

        return { value: normalized, changed: changed };
    }

    function cloneMaintenanceGroups(groups, defaultStatus = 'na') {
        const source = Array.isArray(groups) ? groups : [];
        return source.map(group => ({
            id: (typeof group.id === 'string' ? group.id : nextConfigGroupId()),
            title: (typeof group.title === 'string' ? group.title : ''),
            items: (Array.isArray(group.items) ? group.items : []).map(item => {
                const normalizedSubitems = normalizeSubitems(item && item.subitems);
                return {
                    id: (item && typeof item.id === 'string' && item.id) ? item.id : nextConfigItemId(),
                    label: (item && typeof item.label === 'string') ? item.label : '',
                    subitems: normalizedSubitems,
                    selected_subitems: normalizeSelectedSubitems(item && item.selected_subitems, normalizedSubitems),
                    note: normalizeMaintenanceNote(item && item.note),
                    status: normalizeStatus(item && item.status ? item.status : defaultStatus)
                };
            })
        }));
    }

    function getCurrentConfigGroups() {
        const groups = currentConfig.maintenance_items && Array.isArray(currentConfig.maintenance_items.groups)
            ? currentConfig.maintenance_items.groups
            : [];
        return cloneMaintenanceGroups(groups, 'na');
    }

    function templateFromGroups(groups) {
        return (Array.isArray(groups) ? groups : []).map(group => ({
            id: group.id || '',
            title: group.title || '',
            items: (Array.isArray(group.items) ? group.items : []).map(item => ({
                id: item.id || '',
                label: item.label || '',
                subitems: normalizeSubitems(item && item.subitems)
            }))
        }));
    }

    function hasTemplateMismatchWithCurrentSettings(groups) {
        const left = JSON.stringify(templateFromGroups(groups));
        const right = JSON.stringify(templateFromGroups(getCurrentConfigGroups()));
        return left !== right;
    }

    function normalizeLegacyItems(rawLegacyItems) {
        const source = Array.isArray(rawLegacyItems) ? rawLegacyItems : [];
        return source
            .filter(item => item && typeof item === 'object')
            .map(item => ({
                id: (typeof item.id === 'string' && item.id) ? item.id : nextLegacyItemId(),
                label: (typeof item.label === 'string') ? item.label : '',
                status: normalizeStatus(item.status)
            }))
            .filter(item => item.label.trim().length > 0);
    }

    function dedupeLegacyItems(items) {
        const seen = new Set();
        const out = [];
        (Array.isArray(items) ? items : []).forEach(item => {
            if (!item || typeof item !== 'object') return;
            const label = (typeof item.label === 'string') ? item.label.trim() : '';
            if (!label) return;
            const status = normalizeStatus(item.status);
            // Legacy "na" entries are not meaningful; discard them.
            if (status === 'na') return;
            const key = `${label.toLocaleLowerCase('fi')}|${status}`;
            if (seen.has(key)) return;
            seen.add(key);
            out.push({
                id: (typeof item.id === 'string' && item.id) ? item.id : nextLegacyItemId(),
                label: label,
                status: status
            });
        });
        return out;
    }

    function captureStatusesByItemId() {
        const statuses = {};
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            const input = getStatusInputForItemElement(el);
            if (!input || !el.dataset.itemId) return;
            statuses[el.dataset.itemId] = normalizeStatus(input.value);
        });
        return statuses;
    }

    function captureNotesByItemId() {
        const notes = {};
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            if (!el.dataset.itemId) return;
            const input = getNoteInputForItemElement(el);
            if (!input) return;
            notes[el.dataset.itemId] = normalizeMaintenanceNote(input.value);
        });
        return notes;
    }

    function captureSelectedSubitemsByItemId() {
        const selected = {};
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            if (!el.dataset.itemId) return;
            const values = Array.from(el.querySelectorAll('.maintenance-subitem-btn.selected'))
                .map(btn => (btn.dataset.subitemValue || '').trim())
                .filter(value => value.length > 0);
            selected[el.dataset.itemId] = values;
        });
        return selected;
    }

    function restoreStatusesByItemId(statuses) {
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            if (!el.dataset.itemId) return;
            const status = statuses[el.dataset.itemId];
            if (status) selectStatus(el.id, status);
        });
    }

    function restoreNotesByItemId(notes) {
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            if (!el.dataset.itemId) return;
            if (!Object.prototype.hasOwnProperty.call(notes, el.dataset.itemId)) return;
            const input = getNoteInputForItemElement(el);
            if (!input) return;
            const value = normalizeMaintenanceNote(notes[el.dataset.itemId]);
            input.value = value;
            const noteRow = el.querySelector('.maintenance-note-row');
            const noteToggle = el.querySelector('.item-note-toggle');
            if (noteRow) noteRow.style.display = value ? 'block' : 'none';
            if (noteToggle) noteToggle.classList.toggle('active', value.length > 0);
        });
    }

    function restoreSelectedSubitemsByItemId(selectedByItemId) {
        document.querySelectorAll('.maintenance-item:not(.legacy-item)').forEach(el => {
            if (!el.dataset.itemId) return;
            if (!Object.prototype.hasOwnProperty.call(selectedByItemId, el.dataset.itemId)) return;
            const selectedSet = new Set(normalizeSubitems(selectedByItemId[el.dataset.itemId]));
            el.querySelectorAll('.maintenance-subitem-btn').forEach(btn => {
                const value = (btn.dataset.subitemValue || '').trim();
                const isSelected = !!value && selectedSet.has(value);
                btn.classList.toggle('selected', isSelected);
                btn.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
            });
        });
    }

    function initializeNewReportMaintenance() {
        currentReportMaintenance = {
            schema_version: MAINTENANCE_SCHEMA_VERSION,
            groups: getCurrentConfigGroups(),
            legacy_items: []
        };
        currentReportHasSettingsMismatch = false;
        currentReportLoadedFromLegacyFormat = false;
    }

    function normalizeMaintenanceV2(raw) {
        if (!raw || typeof raw !== 'object') return null;
        const sourceGroups = Array.isArray(raw.groups) ? raw.groups : [];
        const normalizedGroups = cloneMaintenanceGroups(sourceGroups, 'na');
        const normalizedLegacyItems = dedupeLegacyItems(normalizeLegacyItems(raw.legacy_items));
        if (normalizedGroups.length === 0 && normalizedLegacyItems.length === 0) return null;
        return {
            schema_version: MAINTENANCE_SCHEMA_VERSION,
            groups: normalizedGroups,
            legacy_items: normalizedLegacyItems
        };
    }

    function buildMaintenanceFromLegacyFlatItems(reportItems) {
        const flatItems = (reportItems && typeof reportItems === 'object') ? reportItems : {};
        const groups = getCurrentConfigGroups();
        const matchedLabels = new Set();

        groups.forEach(group => {
            group.items.forEach(item => {
                if (Object.prototype.hasOwnProperty.call(flatItems, item.label)) {
                    item.status = normalizeStatus(flatItems[item.label]);
                    matchedLabels.add(item.label);
                }
            });
        });

        const legacy_items = [];
        Object.entries(flatItems).forEach(([label, status]) => {
            if (!matchedLabels.has(label)) {
                legacy_items.push({
                    id: nextLegacyItemId(),
                    label: label,
                    status: normalizeStatus(status)
                });
            }
        });

        return {
            schema_version: MAINTENANCE_SCHEMA_VERSION,
            groups: groups,
            legacy_items: dedupeLegacyItems(legacy_items)
        };
    }

    function readMaintenanceForCurrentReport(data) {
        const v2 = normalizeMaintenanceV2(data.maintenance_v2);
        if (v2) {
            currentReportMaintenance = v2;
            currentReportLoadedFromLegacyFormat = false;
            currentReportHasSettingsMismatch = hasTemplateMismatchWithCurrentSettings(v2.groups);
            return;
        }

        currentReportMaintenance = buildMaintenanceFromLegacyFlatItems(data.items || {});
        currentReportLoadedFromLegacyFormat = true;
        currentReportHasSettingsMismatch = true;
    }

    function collectMaintenanceV2ForSave() {
        const statusByItemId = captureStatusesByItemId();
        const noteByItemId = captureNotesByItemId();
        const selectedSubitemsByItemId = captureSelectedSubitemsByItemId();
        const groups = cloneMaintenanceGroups(currentReportMaintenance.groups, 'na').map(group => ({
            id: group.id,
            title: group.title,
            items: group.items.map(item => {
                const normalizedSubitems = normalizeSubitems(item.subitems);
                const selectedSource = Object.prototype.hasOwnProperty.call(selectedSubitemsByItemId, item.id)
                    ? selectedSubitemsByItemId[item.id]
                    : item.selected_subitems;
                return {
                    id: item.id,
                    label: item.label,
                    subitems: normalizedSubitems,
                    selected_subitems: normalizeSelectedSubitems(selectedSource, normalizedSubitems),
                    note: normalizeMaintenanceNote(noteByItemId[item.id] ?? item.note),
                    status: normalizeStatus(statusByItemId[item.id] || item.status || 'na')
                };
            })
        }));
        const legacy_items = dedupeLegacyItems(normalizeLegacyItems(currentReportMaintenance.legacy_items));
        return { schema_version: MAINTENANCE_SCHEMA_VERSION, groups: groups, legacy_items: legacy_items };
    }

    function flattenMaintenanceItems(maintenanceV2) {
        const flat = {};
        const payload = maintenanceV2 && typeof maintenanceV2 === 'object' ? maintenanceV2 : {};
        (Array.isArray(payload.groups) ? payload.groups : []).forEach(group => {
            (Array.isArray(group.items) ? group.items : []).forEach(item => {
                flat[item.label] = normalizeStatus(item.status);
            });
        });
        (Array.isArray(payload.legacy_items) ? payload.legacy_items : []).forEach(item => {
            flat[item.label] = normalizeStatus(item.status);
        });
        return flat;
    }

    function shouldShowReportUpdateBanner() {
        const reportId = document.getElementById('report-id');
        return !!(reportId && reportId.value) && (currentReportHasSettingsMismatch || currentReportLoadedFromLegacyFormat);
    }

    function updateReportUpdateBanner() {
        const banner = document.getElementById('report-update-banner');
        if (!banner) return;
        if (shouldShowReportUpdateBanner()) {
            banner.style.display = 'block';
        } else {
            banner.style.display = 'none';
        }
    }
    
    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('report_date').valueAsDate = new Date();
        updateCalendarModeButton();
        updateSearchClearButton();
        const authInput = document.getElementById('auth-password-input');
        const usePwCheckbox = document.getElementById('conf_use_password');
        if (authInput) {
            authInput.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    submitAuthPassword();
                }
            });
        }
        if (usePwCheckbox) {
            usePwCheckbox.addEventListener('change', updateSecurityPasswordInputState);
        }
        document.addEventListener('keydown', handleGlobalShortcuts);
        document.addEventListener('keydown', event => {
            if (event.key === 'Escape') closeCalendarDayMenu();
        });
        document.addEventListener('click', handleCalendarOutsideClick);
        window.addEventListener('resize', handleCalendarViewportChange);
        window.addEventListener('scroll', handleCalendarViewportChange, true);
        initReportDirtyTracking();
        initConfigDirtyTracking();
        loadConfig();
        loadReports();
    });

    // --- Navigation & Views ---
    function showDashboard() {
        if (!confirmDiscardUnsavedReportChanges('Raportit')) return;
        if (!confirmDiscardUnsavedConfigChanges('Raportit')) return;
        switchView('dashboard-view');
        if (isCalendarMode) {
            setCalendarMode(false);
            return;
        }
        // If coming back to dashboard, refresh to see changes (e.g. date)
        invalidateCalendarCache();
        loadReports();
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        // Reset selection mode when leaving dashboard
        if(viewId !== 'dashboard-view' && isSelectionMode) {
            toggleSelectionMode(); 
        }
        if (viewId !== 'dashboard-view') {
            closeCalendarDayMenu();
        }
    }

    function createNewReport(options = {}) {
        const opts = options && typeof options === 'object' ? options : {};
        const skipUnsavedPrompt = !!opts.skipUnsavedPrompt;
        const skipBaseline = !!opts.skipBaseline;

        if (!skipUnsavedPrompt && !confirmDiscardUnsavedReportChanges('Uusi raportti')) return;
        if (!skipUnsavedPrompt && !confirmDiscardUnsavedConfigChanges('Uusi raportti')) return;

        withDirtyTrackingPaused(() => {
            document.getElementById('report-form').reset();
            document.getElementById('report-id').value = '';
            document.getElementById('report_date').valueAsDate = new Date();
            initializeNewReportMaintenance();
            renderMaintenanceSections();
            currentAttachments = [];
            renderAttachmentList();
        });

        if (!skipBaseline) {
            markCurrentReportAsSaved();
        }
        switchView('editor-view');
    }

    function showConfig() {
        if (isConfigViewActive()) return;
        if (!confirmDiscardUnsavedReportChanges('Asetukset')) return;
        if (!confirmDiscardUnsavedConfigChanges('Asetukset')) return;
        switchView('config-view');
        withConfigDirtyTrackingPaused(() => {
            initConfigEditor(currentConfig.maintenance_items);
            initMaintenanceSetEditor(currentConfig.maintenance_sets);
            const settings = currentConfig.shop_settings || {};
            const security = currentConfig.security || {};
            const statusLabels = normalizeStatusLabels(settings.status_labels);
            document.getElementById('conf_company_text').value = settings.company_text || '';
            document.getElementById('conf_hide_na').checked = !!settings.hide_na_in_print;
            document.getElementById('conf_accent_color').value = normalizeAccentColor(settings.accent_color);
            document.getElementById('conf_status_done').value = statusLabels.done;
            document.getElementById('conf_status_not_done').value = statusLabels.not_done;
            document.getElementById('conf_status_na').value = statusLabels.na;
            document.getElementById('conf_use_password').checked = !!security.password_enabled;
            document.getElementById('conf_password_label').textContent = security.password_enabled
                ? 'Vaihda salasana'
                : 'Aseta salasana';
            document.getElementById('conf_api_password').value = '';
            document.getElementById('conf_api_password').placeholder = security.password_enabled
                ? '********'
                : 'Anna salasana';
            updateSecurityPasswordInputState();

            const preview = document.getElementById('conf_logo_preview');
            const delBtn = document.getElementById('btn_delete_logo');
            preview.src = `api/attachment?id=${STATIC_LOGO_ID}&t=${Date.now()}`;
            preview.onload = function() { preview.style.display = 'block'; delBtn.style.display = 'inline-block'; };
            preview.onerror = function() { preview.style.display = 'none'; delBtn.style.display = 'none'; };
            const newSetInput = document.getElementById('new-maintenance-set-name');
            if (newSetInput) newSetInput.value = '';
        });
        markCurrentConfigAsSaved();
    }

    function updateCalendarModeButton() {
        const btn = document.getElementById('btn-calendar-mode');
        if (!btn) return;
        const icon = btn.querySelector('i');
        const longText = btn.querySelector('.btn-text');
        const shortText = btn.querySelector('.btn-text-short');
        if (isCalendarMode) {
            if (icon) icon.className = 'fas fa-list';
            if (longText) longText.textContent = 'Lista';
            if (shortText) shortText.textContent = '';
            btn.classList.add('active');
            btn.title = 'Vaihda listanäkymään';
        } else {
            if (icon) icon.className = 'fas fa-calendar-alt';
            if (longText) longText.textContent = 'Kalenteri';
            if (shortText) shortText.textContent = '';
            btn.classList.remove('active');
            btn.title = 'Vaihda kalenterinäkymään';
        }
    }

    function toggleCalendarMode() {
        setCalendarMode(!isCalendarMode);
    }

    function setCalendarMode(enabled) {
        const nextMode = !!enabled;
        if (nextMode === isCalendarMode) {
            if (nextMode) loadReports();
            return;
        }
        if (nextMode && isSelectionMode) {
            toggleSelectionMode();
        }
        isCalendarMode = nextMode;
        const dashboard = document.getElementById('dashboard-view');
        if (dashboard) dashboard.classList.toggle('calendar-mode', isCalendarMode);
        if (!isCalendarMode) closeCalendarDayMenu();
        updateCalendarModeButton();
        loadReports();
    }

    function invalidateCalendarCache() {
        calendarReportsByDate = {};
        calendarLoadedRange = { start: '', end: '' };
    }

    function shiftCalendarMonths(delta) {
        if (!isCalendarMode) return;
        calendarStartMonth = addMonths(calendarStartMonth, delta);
        closeCalendarDayMenu();
        loadReports();
    }

    function jumpCalendarToToday() {
        if (!isCalendarMode) return;
        const now = new Date();
        calendarStartMonth = getMonthStart(now);
        closeCalendarDayMenu();
        loadReports();
    }

    function handleCalendarOutsideClick(event) {
        if (!isCalendarMode || !calendarMenuDate) return;
        if (event.target.closest('.calendar-day')) return;
        if (event.target.closest('#calendar-day-menu')) return;
        closeCalendarDayMenu();
    }

    function handleCalendarViewportChange() {
        if (!isCalendarMode || !calendarMenuDate) return;
        const dayButton = document.querySelector(`.calendar-day[data-calendar-date="${calendarMenuDate}"]`);
        if (!dayButton) {
            closeCalendarDayMenu();
            return;
        }
        positionCalendarDayMenu(dayButton);
    }

    async function loadCalendarData() {
        const firstMonth = getMonthStart(calendarStartMonth);
        const secondMonth = addMonths(firstMonth, 1);
        const rangeStart = formatIsoDate(firstMonth);
        const rangeEnd = formatIsoDate(getMonthEnd(secondMonth));

        if (calendarLoadedRange.start === rangeStart && calendarLoadedRange.end === rangeEnd) return;

        const res = await apiFetch(`api/reports_by_date?start=${encodeURIComponent(rangeStart)}&end=${encodeURIComponent(rangeEnd)}&t=${Date.now()}`);
        if (!res.ok) {
            calendarReportsByDate = {};
            calendarLoadedRange = { start: rangeStart, end: rangeEnd };
            return;
        }

        const data = await res.json();
        const grouped = {};
        (data.items || []).forEach(raw => {
            const dateIso = normalizeIsoDate(raw.report_date);
            if (!dateIso) return;
            if (!grouped[dateIso]) grouped[dateIso] = [];
            grouped[dateIso].push({
                id: raw.id,
                report_date: dateIso,
                license_plate: (raw.license_plate || '-').trim() || '-',
                customer_name: ((raw.customer_name || '-').trim().split('\n')[0] || '-')
            });
        });
        calendarReportsByDate = grouped;
        calendarLoadedRange = { start: rangeStart, end: rangeEnd };
    }

    function getCalendarDayCountClass(count) {
        if (count === 1) return 'has-reports-1';
        if (count === 2) return 'has-reports-2';
        if (count >= 3) return 'has-reports-3';
        return '';
    }

    function getCalendarItemsForDate(dateIso) {
        const entries = calendarReportsByDate[dateIso];
        return Array.isArray(entries) ? entries : [];
    }

    function renderCalendarView() {
        const container = document.getElementById('calendar-months');
        if (!container) return;
        const firstMonth = getMonthStart(calendarStartMonth);
        const secondMonth = addMonths(firstMonth, 1);
        container.innerHTML = '';
        container.appendChild(buildCalendarMonthCard(firstMonth));
        container.appendChild(buildCalendarMonthCard(secondMonth));

        if (calendarMenuDate) {
            const dayButton = document.querySelector(`.calendar-day[data-calendar-date="${calendarMenuDate}"]`);
            if (dayButton) positionCalendarDayMenu(dayButton);
            else closeCalendarDayMenu();
        }
    }

    function buildCalendarMonthCard(monthDate) {
        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();
        const todayIso = formatIsoDate(new Date());
        const firstWeekday = (new Date(year, month, 1).getDay() + 6) % 7;
        const dayCount = new Date(year, month + 1, 0).getDate();

        const card = document.createElement('div');
        card.className = 'calendar-month-card';

        const title = document.createElement('div');
        title.className = 'calendar-month-title';
        title.textContent = formatCalendarMonthLabel(monthDate);
        card.appendChild(title);

        const weekdays = document.createElement('div');
        weekdays.className = 'calendar-weekdays';
        CALENDAR_WEEKDAY_LABELS.forEach(label => {
            const cell = document.createElement('div');
            cell.textContent = label;
            weekdays.appendChild(cell);
        });
        card.appendChild(weekdays);

        const daysGrid = document.createElement('div');
        daysGrid.className = 'calendar-days';

        for (let i = 0; i < firstWeekday; i += 1) {
            const placeholder = document.createElement('div');
            placeholder.className = 'calendar-day-placeholder';
            daysGrid.appendChild(placeholder);
        }

        for (let day = 1; day <= dayCount; day += 1) {
            const dateObj = new Date(year, month, day);
            const dateIso = formatIsoDate(dateObj);
            const reports = getCalendarItemsForDate(dateIso);

            const dayButton = document.createElement('button');
            dayButton.type = 'button';
            dayButton.className = 'calendar-day';
            dayButton.dataset.calendarDate = dateIso;
            const intensityClass = getCalendarDayCountClass(reports.length);
            if (intensityClass) dayButton.classList.add(intensityClass);
            if (dateIso === todayIso) dayButton.classList.add('today');
            dayButton.title = reports.length > 0 ? `${reports.length} raporttia` : 'Ei raportteja';
            dayButton.addEventListener('click', event => {
                event.stopPropagation();
                openCalendarDayMenu(dateIso, dayButton);
            });

            const number = document.createElement('span');
            number.className = 'day-number';
            number.textContent = String(day);
            dayButton.appendChild(number);

            if (reports.length > 0) {
                const count = document.createElement('span');
                count.className = 'day-count';
                count.textContent = String(reports.length);
                dayButton.appendChild(count);
            }

            daysGrid.appendChild(dayButton);
        }

        const usedCells = firstWeekday + dayCount;
        const trailingCells = (7 - (usedCells % 7)) % 7;
        for (let i = 0; i < trailingCells; i += 1) {
            const placeholder = document.createElement('div');
            placeholder.className = 'calendar-day-placeholder';
            daysGrid.appendChild(placeholder);
        }

        card.appendChild(daysGrid);
        return card;
    }

    function openCalendarDayMenu(dateIso, anchorEl) {
        const menu = document.getElementById('calendar-day-menu');
        const title = document.getElementById('calendar-day-menu-title');
        const list = document.getElementById('calendar-day-menu-list');
        if (!menu || !title || !list) return;

        calendarMenuDate = dateIso;
        title.textContent = formatCalendarDayLabel(dateIso);
        list.innerHTML = '';

        const reports = getCalendarItemsForDate(dateIso);
        if (reports.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'calendar-day-menu-empty';
            empty.textContent = 'Ei raportteja tälle päivälle.';
            list.appendChild(empty);
        } else {
            reports.forEach(report => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'calendar-day-menu-item';
                item.addEventListener('click', () => {
                    closeCalendarDayMenu();
                    openReport(report.id);
                });

                const plate = document.createElement('span');
                plate.className = 'calendar-day-menu-plate';
                plate.textContent = report.license_plate || '-';
                item.appendChild(plate);

                const customer = document.createElement('span');
                customer.className = 'calendar-day-menu-customer';
                customer.textContent = report.customer_name || '-';
                item.appendChild(customer);

                list.appendChild(item);
            });
        }

        menu.classList.remove('hidden');
        positionCalendarDayMenu(anchorEl);
    }

    function positionCalendarDayMenu(anchorEl) {
        const menu = document.getElementById('calendar-day-menu');
        if (!menu || !anchorEl || menu.classList.contains('hidden')) return;

        const anchorRect = anchorEl.getBoundingClientRect();
        menu.style.left = '10px';
        menu.style.top = '10px';
        const menuRect = menu.getBoundingClientRect();

        let left = anchorRect.left;
        let top = anchorRect.bottom + 8;

        if (left + menuRect.width > window.innerWidth - 10) {
            left = window.innerWidth - menuRect.width - 10;
        }
        if (left < 10) left = 10;

        if (top + menuRect.height > window.innerHeight - 10) {
            top = anchorRect.top - menuRect.height - 8;
        }
        if (top < 10) top = 10;

        menu.style.left = `${Math.round(left)}px`;
        menu.style.top = `${Math.round(top)}px`;
    }

    function closeCalendarDayMenu() {
        const menu = document.getElementById('calendar-day-menu');
        if (menu) menu.classList.add('hidden');
        calendarMenuDate = '';
    }

    function createNewReportFromCalendarDay() {
        const dateIso = normalizeIsoDate(calendarMenuDate);
        if (!dateIso) return;
        closeCalendarDayMenu();
        createNewReport();
        const editorView = document.getElementById('editor-view');
        if (!(editorView && editorView.classList.contains('active'))) return;
        withDirtyTrackingPaused(() => {
            document.getElementById('report_date').value = dateIso;
        });
        markCurrentReportAsSaved();
    }

    // --- Selection Mode Logic ---
    function toggleSelectionMode() {
        if (isCalendarMode) return;
        isSelectionMode = !isSelectionMode;
        const dash = document.getElementById('dashboard-view');
        const btn = document.getElementById('btn-select-mode');
        const btnDel = document.getElementById('btn-delete-selected');

        if(isSelectionMode) {
            dash.classList.add('selection-mode');
            btn.classList.add('active');
            btnDel.style.display = 'inline-flex';
        } else {
            dash.classList.remove('selection-mode');
            btn.classList.remove('active');
            btnDel.style.display = 'none';
            // Uncheck all
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = false);
            updateDeleteButtonState();
        }
    }

    function updateDeleteButtonState() {
        let checked = 0;
        document.querySelectorAll('#report-table-body tr').forEach(tr => {
            const cb = tr.querySelector('.row-checkbox');
            const isChecked = !!(cb && cb.checked);
            tr.classList.toggle('row-selected', isChecked);
            if (isChecked) checked += 1;
        });
        const btn = document.getElementById('btn-delete-selected');
        btn.disabled = checked === 0;
        btn.querySelector('.btn-text').textContent = `Poista (${checked})`;
    }

    function toggleSelectAll() {
        const master = document.getElementById('select-all');
        document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = master.checked);
        updateDeleteButtonState();
    }

    async function deleteSelectedReports() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => cb.value);
        
        if(ids.length === 0) return;

        if(confirm(`Haluatko varmasti poistaa ${ids.length} raporttia? Tämä poistaa myös raporttien liitteet pysyvästi.`)) {
            const res = await apiFetch('api/delete_reports', {
                method: 'POST',
                body: JSON.stringify({ ids: ids })
            });
            const data = await res.json();
            if(data.status === 'deleted') {
                toggleSelectionMode(); // Exit mode
                invalidateCalendarCache();
                loadReports(); // Refresh
            } else {
                alert('Virhe poistossa');
            }
        }
    }

    // --- Data Loading ---
    async function loadConfig() {
        const res = await apiFetch('api/config?t=' + new Date().getTime());
        const data = await res.json();
        const normalizedMaintenance = normalizeMaintenanceConfig(data.maintenance_items || {});
        currentConfig.maintenance_items = normalizedMaintenance.value;
        const normalizedMaintenanceSets = normalizeMaintenanceSets(data.maintenance_sets || {}, currentConfig.maintenance_items);
        currentConfig.maintenance_sets = normalizedMaintenanceSets.value;
        const loadedSettings = data.shop_settings || {};
        const loadedSecurity = (data.security && typeof data.security === 'object') ? data.security : {};
        const normalizedStatusLabels = applyStatusLabels(loadedSettings.status_labels);
        currentConfig.shop_settings = {
            ...loadedSettings,
            accent_color: normalizeAccentColor(loadedSettings.accent_color),
            status_labels: normalizedStatusLabels
        };
        currentConfig.security = {
            password_enabled: !!loadedSecurity.password_enabled
        };
        applyAccentColor(currentConfig.shop_settings.accent_color);
        if (normalizedMaintenance.changed || normalizedMaintenanceSets.changed) {
            try {
                await apiFetch('api/save_config', {
                    method: 'POST',
                    body: JSON.stringify({
                        maintenance_items: currentConfig.maintenance_items,
                        maintenance_sets: currentConfig.maintenance_sets
                    })
                });
            } catch (e) {
                console.warn('Maintenance config schema migration save failed', e);
            }
        }
        initializeNewReportMaintenance();
        renderMaintenanceSections();
        renderMaintenanceSetSection();
    }

    function handleSearch() {
        updateSearchClearButton();
        if (isCalendarMode) return;
        clearTimeout(searchTimeout);
        const val = document.getElementById('search-input').value;
        // Don't search if only 1 char
        if (val.length === 1) return;
        
        searchTimeout = setTimeout(() => {
            currentPage = 1; // Reset to page 1 on new search
            loadReports();
        }, 300);
    }

    function updateSearchClearButton() {
        const input = document.getElementById('search-input');
        const btn = document.getElementById('search-clear-btn');
        if (!input || !btn) return;
        btn.classList.toggle('hidden', !input.value.trim());
    }

    function clearSearch() {
        const input = document.getElementById('search-input');
        if (!input) return;
        input.value = '';
        updateSearchClearButton();
        currentPage = 1;
        invalidateCalendarCache();
        loadReports();
        input.focus();
    }

    function changePage(delta) {
        if (isCalendarMode) return;
        currentPage += delta;
        loadReports();
    }

    async function loadReports() {
        if (isCalendarMode) {
            await loadCalendarData();
            renderCalendarView();
            return;
        }
        closeCalendarDayMenu();
        await loadReportList();
    }

    async function loadReportList() {
        const q = document.getElementById('search-input').value;
        const res = await apiFetch(`api/reports?q=${encodeURIComponent(q)}&page=${currentPage}&limit=${itemsPerPage}&t=` + Date.now());
        const data = await res.json();
        
        // Handle response format (API now returns object)
        const reports = data.items || [];
        totalItems = data.total || 0;
        const totalPages = data.pages || 1;

        const tbody = document.getElementById('report-table-body');
        tbody.innerHTML = '';
        
        reports.forEach(r => {
            let vehicleModel = '-';
            try {
                if(r.data) {
                    const parsed = JSON.parse(r.data);
                    vehicleModel = parsed.vehicle_model || '-';
                }
            } catch(e) {}

            // Customer Name: First line only
            let customerNameDisplay = r.customer_name || '-';
            customerNameDisplay = customerNameDisplay.split('\n')[0];
            const dateDisplay = (r.report_date || '-').trim() || '-';
            const plateDisplay = (r.license_plate || '-').trim() || '-';
            const vehicleDisplay = (vehicleModel || '-').trim() || '-';

            const tr = document.createElement('tr');
            
            // Checkbox Cell
            const tdCheck = document.createElement('td');
            tdCheck.className = 'col-select';
            const rowCheckbox = document.createElement('input');
            rowCheckbox.type = 'checkbox';
            rowCheckbox.className = 'row-checkbox';
            rowCheckbox.value = String(r.id);
            rowCheckbox.addEventListener('click', event => event.stopPropagation());
            rowCheckbox.addEventListener('change', updateDeleteButtonState);
            tdCheck.appendChild(rowCheckbox);
            tr.appendChild(tdCheck);

            // Data Cells
            const appendCell = (txt, className = '') => {
                const td = document.createElement('td');
                if (className) td.className = className;
                td.textContent = txt;
                tr.appendChild(td);
            };
            appendCell(dateDisplay, 'col-date');
            appendCell(customerNameDisplay, 'col-customer');

            const tdPlate = document.createElement('td');
            tdPlate.className = 'col-plate';
            tdPlate.innerHTML = `${escapeHtml(plateDisplay)}<span class="col-plate-mobile-vehicle"> - ${escapeHtml(vehicleDisplay)}</span>`;
            tr.appendChild(tdPlate);

            appendCell(vehicleDisplay, 'col-vehicle');

            // Row Click
            tr.onclick = (e) => {
                // If in selection mode, toggle checkbox instead of opening
                if(isSelectionMode) {
                    const cb = tr.querySelector('.row-checkbox');
                    cb.checked = !cb.checked;
                    updateDeleteButtonState();
                } else {
                    openReport(r.id);
                }
            };
            
            tbody.appendChild(tr);
        });

        // Update Pagination UI
        document.getElementById('btn-prev').disabled = currentPage <= 1;
        document.getElementById('btn-next').disabled = currentPage >= totalPages;
        document.getElementById('pagination-info').textContent = `Sivu ${currentPage} / ${totalPages || 1}`;
        const selectAll = document.getElementById('select-all');
        if (selectAll) selectAll.checked = false;
        updateDeleteButtonState();
    }

    // --- Attachments ---
    function uploadFile(input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                const uuid = await sendImageToServer(e.target.result, file.type);
                if(uuid) {
                    currentAttachments.push(uuid);
                    renderAttachmentList();
                }
                input.value = '';
            }
            reader.readAsDataURL(file);
        }
    }

    function uploadLogo(input) {
        if(input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function(e) {
                await sendImageToServer(e.target.result, file.type, STATIC_LOGO_ID);
                const preview = document.getElementById('conf_logo_preview');
                preview.src = `api/attachment?id=${STATIC_LOGO_ID}&t=${Date.now()}`;
                preview.style.display = 'block';
                document.getElementById('btn_delete_logo').style.display = 'inline-block';
                input.value = '';
            }
            reader.readAsDataURL(file);
        }
    }

    async function sendImageToServer(base64Data, mime, customId = null) {
        const payload = { image: base64Data, mime: mime };
        if(customId) payload.custom_id = customId;
        const res = await apiFetch('api/upload_attachment', { method: 'POST', body: JSON.stringify(payload) });
        const data = await res.json();
        return data.uuid;
    }

    function renderAttachmentList() {
        const list = document.getElementById('attachment-list');
        list.innerHTML = '';
        currentAttachments.forEach(uuid => {
            const img = document.createElement('img');
            img.src = 'api/attachment?id=' + uuid;
            img.className = 'attachment-thumb';
            addLongPressHandler(img, 
                () => openImageModal(img.src), 
                async () => {
                    // Immediate deletion logic
                    if(confirm("Haluatko poistaa kuvan pysyvästi? Tätä toimintoa ei voi peruuttaa.")) {
                        try {
                            const res = await apiFetch('api/delete_attachment', {
                                method: 'POST',
                                body: JSON.stringify({ id: uuid })
                            });
                            const data = await res.json();
                            if(data.status === 'deleted') {
                                currentAttachments = currentAttachments.filter(id => id !== uuid);
                                renderAttachmentList();
                            }
                        } catch(e) {
                            alert("Virhe poistossa");
                        }
                    }
                }
            );
            list.appendChild(img);
        });
        evaluateReportDirtyState();
    }

    function addLongPressHandler(element, onClick, onLongPress) {
        let timer;
        let isLongPress = false;
        const start = (e) => {
            if(e.type === 'touchstart' || e.button === 0) {
                isLongPress = false;
                timer = setTimeout(() => {
                    isLongPress = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    onLongPress();
                }, 600);
            }
        };
        const end = (e) => {
            if (timer) { clearTimeout(timer); timer = null; }
            if (!isLongPress) onClick();
        };
        const cancel = () => {
            if (timer) { clearTimeout(timer); timer = null; }
            isLongPress = false;
        };
        element.addEventListener('mousedown', start);
        element.addEventListener('touchstart', start, {passive: true});
        element.addEventListener('mouseup', end);
        element.addEventListener('touchend', end);
        element.addEventListener('mousemove', cancel);
        element.addEventListener('touchmove', cancel);
    }

    // --- Other Functions (Existing Logic) ---
    function openImageModal(src) {
        document.getElementById('modal-img-element').src = src;
        document.getElementById('image-modal').style.display = 'flex';
    }
    function closeImageModal() { document.getElementById('image-modal').style.display = 'none'; }
    
    async function deleteLogo() {
        if(confirm("Poistetaanko logo?")) {
            await apiFetch('api/delete_attachment', { method: 'POST', body: JSON.stringify({ id: STATIC_LOGO_ID }) });
            document.getElementById('conf_logo_preview').style.display = 'none';
            document.getElementById('btn_delete_logo').style.display = 'none';
        }
    }

    function initConfigEditor(maintenanceItems) {
        const normalized = normalizeMaintenanceConfig(maintenanceItems);
        const sourceGroups = normalized.value.groups;
        configEditorState = {
            groups: sourceGroups.map(group => ({
                id: group.id,
                title: (group && typeof group.title === 'string') ? group.title : '',
                items: (group && Array.isArray(group.items) ? group.items : []).map(item => ({
                    id: (item && typeof item.id === 'string' && item.id) ? item.id : nextConfigItemId(),
                    label: (item && typeof item.label === 'string') ? item.label : '',
                    subitems: normalizeSubitems(item && item.subitems)
                }))
            }))
        };
        renderConfigEditor();
    }

    function getMaintenanceItemsFromEditor() {
        return {
            schema_version: MAINTENANCE_SCHEMA_VERSION,
            groups: configEditorState.groups
                .map(group => ({
                    id: (group.id || nextConfigGroupId()),
                    title: (group.title || '').trim(),
                    items: group.items
                        .map(item => {
                            const subitems = normalizeSubitems(item.subitems);
                            const normalized = {
                                id: (item.id || nextConfigItemId()),
                                label: (item.label || '').trim()
                            };
                            if (subitems.length > 0) normalized.subitems = subitems;
                            return normalized;
                        })
                        .filter(item => item.label.length > 0)
                }))
                .filter(group => group.title.length > 0 || group.items.length > 0)
        };
    }

    function updateConfigJsonPreview() {
        const preview = document.getElementById('config-json');
        if (!preview) return;
        preview.value = JSON.stringify(getMaintenanceItemsFromEditor(), null, 4);
    }

    function moveArrayElement(arr, fromIndex, toIndex) {
        if (fromIndex === toIndex || fromIndex < 0 || toIndex < 0 || fromIndex >= arr.length || toIndex > arr.length) return;
        const [moved] = arr.splice(fromIndex, 1);
        arr.splice(toIndex, 0, moved);
    }

    function findGroupById(groupId) {
        return configEditorState.groups.find(group => group.id === groupId);
    }

    function findConfigItem(groupId, itemId) {
        const group = findGroupById(groupId);
        if (!group) return null;
        return group.items.find(item => item.id === itemId) || null;
    }

    function clearConfigDragStyles() {
        document.querySelectorAll('.config-group, .config-item, .config-group-items').forEach(el => {
            el.classList.remove('dragging', 'drag-over', 'drop-target');
        });
    }

    function onConfigDragEnd() {
        clearConfigDragStyles();
        configDragState = null;
    }

    function onConfigGroupDragStart(event, groupId) {
        configDragState = { type: 'group', groupId: groupId };
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', groupId);
        const groupEl = event.target.closest('.config-group');
        if (groupEl) groupEl.classList.add('dragging');
    }

    function onConfigGroupDragOver(event) {
        if (!configDragState || configDragState.type !== 'group') return;
        event.preventDefault();
        event.currentTarget.classList.add('drag-over');
    }

    function onConfigGroupDragLeave(event) {
        event.currentTarget.classList.remove('drag-over');
    }

    function onConfigGroupDrop(event, targetGroupId) {
        if (!configDragState || configDragState.type !== 'group') return;
        event.preventDefault();
        event.stopPropagation();
        const draggedGroupId = configDragState.groupId;
        const fromIndex = configEditorState.groups.findIndex(group => group.id === draggedGroupId);
        const targetIndex = configEditorState.groups.findIndex(group => group.id === targetGroupId);
        if (fromIndex < 0 || targetIndex < 0) {
            onConfigDragEnd();
            return;
        }
        const rect = event.currentTarget.getBoundingClientRect();
        let insertIndex = targetIndex + (event.clientY > (rect.top + rect.height / 2) ? 1 : 0);
        if (fromIndex < insertIndex) insertIndex -= 1;
        moveArrayElement(configEditorState.groups, fromIndex, insertIndex);
        onConfigDragEnd();
        renderConfigEditor();
    }

    function onConfigItemDragStart(event, groupId, itemId) {
        configDragState = { type: 'item', groupId: groupId, itemId: itemId };
        event.dataTransfer.effectAllowed = 'move';
        event.dataTransfer.setData('text/plain', itemId);
        const itemEl = event.target.closest('.config-item');
        if (itemEl) itemEl.classList.add('dragging');
    }

    function onConfigItemDragOver(event) {
        if (!configDragState || configDragState.type !== 'item') return;
        event.preventDefault();
        event.currentTarget.classList.add('drag-over');
    }

    function onConfigItemDragLeave(event) {
        event.currentTarget.classList.remove('drag-over');
    }

    function onConfigItemDrop(event, targetGroupId, targetItemId) {
        if (!configDragState || configDragState.type !== 'item') return;
        event.preventDefault();
        event.stopPropagation();

        const fromGroup = findGroupById(configDragState.groupId);
        const targetGroup = findGroupById(targetGroupId);
        if (!fromGroup || !targetGroup) {
            onConfigDragEnd();
            return;
        }
        const fromIndex = fromGroup.items.findIndex(item => item.id === configDragState.itemId);
        const targetIndexRaw = targetGroup.items.findIndex(item => item.id === targetItemId);
        if (fromIndex < 0 || targetIndexRaw < 0) {
            onConfigDragEnd();
            return;
        }

        const [movedItem] = fromGroup.items.splice(fromIndex, 1);
        let targetIndex = targetIndexRaw;
        const rect = event.currentTarget.getBoundingClientRect();
        if (event.clientY > (rect.top + rect.height / 2)) targetIndex += 1;
        if (fromGroup.id === targetGroup.id && fromIndex < targetIndex) targetIndex -= 1;
        targetGroup.items.splice(targetIndex, 0, movedItem);

        onConfigDragEnd();
        renderConfigEditor();
    }

    function onConfigItemsContainerDragOver(event) {
        if (!configDragState || configDragState.type !== 'item') return;
        event.preventDefault();
        event.currentTarget.classList.add('drop-target');
    }

    function onConfigItemsContainerDragLeave(event) {
        event.currentTarget.classList.remove('drop-target');
    }

    function onConfigItemsContainerDrop(event, targetGroupId) {
        if (!configDragState || configDragState.type !== 'item') return;
        event.preventDefault();
        event.stopPropagation();

        const fromGroup = findGroupById(configDragState.groupId);
        const targetGroup = findGroupById(targetGroupId);
        if (!fromGroup || !targetGroup) {
            onConfigDragEnd();
            return;
        }

        const fromIndex = fromGroup.items.findIndex(item => item.id === configDragState.itemId);
        if (fromIndex < 0) {
            onConfigDragEnd();
            return;
        }

        const [movedItem] = fromGroup.items.splice(fromIndex, 1);
        targetGroup.items.push(movedItem);

        onConfigDragEnd();
        renderConfigEditor();
    }

    function addConfigGroup() {
        const newGroup = { id: nextConfigGroupId(), title: 'Uusi otsikko', items: [] };
        configEditorState.groups.push(newGroup);
        renderConfigEditor();
        setTimeout(() => {
            const input = document.querySelector(`[data-group-id="${newGroup.id}"] .config-title-input`);
            if (input) input.focus();
        }, 0);
    }

    function addConfigItem(groupId) {
        const group = findGroupById(groupId);
        if (!group) return;
        const newItem = { id: nextConfigItemId(), label: getUniqueConfigItemLabel('Uusi kohde', groupId), subitems: [] };
        group.items.push(newItem);
        renderConfigEditor();
        setTimeout(() => {
            const input = document.querySelector(`[data-item-id="${newItem.id}"] .config-item-input`);
            if (input) input.focus();
        }, 0);
    }

    function addConfigSubitem(groupId, itemId) {
        const item = findConfigItem(groupId, itemId);
        if (!item) return;
        if (!Array.isArray(item.subitems)) item.subitems = [];
        item.subitems.push('Uusi lisatieto');
        const subitemIndex = item.subitems.length - 1;
        renderConfigEditor();
        setTimeout(() => {
            const input = document.querySelector(`[data-item-id="${itemId}"] .config-subitem-input[data-subitem-index="${subitemIndex}"]`);
            if (input) input.focus();
        }, 0);
    }

    function removeConfigSubitem(groupId, itemId, subitemIndex) {
        const item = findConfigItem(groupId, itemId);
        if (!item || !Array.isArray(item.subitems)) return;
        if (subitemIndex < 0 || subitemIndex >= item.subitems.length) return;
        item.subitems.splice(subitemIndex, 1);
        renderConfigEditor();
    }

    function removeConfigGroup(groupId) {
        const group = findGroupById(groupId);
        if (!group) return;
        if (!confirm(`Poistetaanko otsikko "${group.title || 'Nimeton'}" ja kaikki sen kohteet?`)) return;
        configEditorState.groups = configEditorState.groups.filter(g => g.id !== groupId);
        renderConfigEditor();
    }

    function removeConfigItem(groupId, itemId) {
        const group = findGroupById(groupId);
        if (!group) return;
        const item = group.items.find(entry => entry.id === itemId);
        if (!item) return;
        if (!confirm(`Poistetaanko kohde "${item.label || 'Nimeton'}"?`)) return;
        group.items = group.items.filter(item => item.id !== itemId);
        renderConfigEditor();
    }

    function normalizeConfigItemLabel(label) {
        return (label || '').trim().toLocaleLowerCase('fi');
    }

    function hasDuplicateConfigItemLabel(label, groupId, excludeItemId = null) {
        const group = findGroupById(groupId);
        if (!group) return false;
        const normalized = normalizeConfigItemLabel(label);
        if (!normalized) return false;
        for (const item of group.items) {
            if (excludeItemId && item.id === excludeItemId) continue;
            if (normalizeConfigItemLabel(item.label) === normalized) return true;
        }
        return false;
    }

    function getDuplicateConfigItemLabelsInSameGroupFromMaintenance(maintenanceItems) {
        const sourceGroups = (maintenanceItems && Array.isArray(maintenanceItems.groups))
            ? maintenanceItems.groups
            : [];
        const duplicates = [];
        sourceGroups.forEach(group => {
            const seen = new Set();
            const groupTitle = (group.title || '').trim() || 'Nimeton otsikko';
            const items = Array.isArray(group.items) ? group.items : [];
            items.forEach(item => {
                const label = (item && typeof item.label === 'string') ? item.label : '';
                const normalized = normalizeConfigItemLabel(label);
                if (!normalized) return;
                if (seen.has(normalized)) {
                    duplicates.push({
                        groupTitle: groupTitle,
                        label: label.trim() || 'Nimeton'
                    });
                }
                seen.add(normalized);
            });
        });
        return duplicates;
    }

    function getDuplicateConfigItemLabelsInSameGroup() {
        return getDuplicateConfigItemLabelsInSameGroupFromMaintenance(getMaintenanceItemsFromEditor());
    }

    function getUniqueConfigItemLabel(baseLabel, groupId) {
        let candidate = baseLabel;
        let suffix = 2;
        while (hasDuplicateConfigItemLabel(candidate, groupId)) {
            candidate = `${baseLabel} ${suffix}`;
            suffix += 1;
        }
        return candidate;
    }

    function renderConfigEditor() {
        const groupsContainer = document.getElementById('config-groups');
        if (!groupsContainer) return;
        groupsContainer.innerHTML = '';

        configEditorState.groups.forEach(group => {
            const groupEl = document.createElement('div');
            groupEl.className = 'config-group';
            groupEl.dataset.groupId = group.id;
            groupEl.addEventListener('dragover', onConfigGroupDragOver);
            groupEl.addEventListener('dragleave', onConfigGroupDragLeave);
            groupEl.addEventListener('drop', event => onConfigGroupDrop(event, group.id));

            const headerEl = document.createElement('div');
            headerEl.className = 'config-group-header';

            const groupDragHandle = document.createElement('span');
            groupDragHandle.className = 'drag-handle';
            groupDragHandle.textContent = '::';
            groupDragHandle.title = 'Vedä otsikkoa';
            groupDragHandle.draggable = true;
            groupDragHandle.addEventListener('dragstart', event => onConfigGroupDragStart(event, group.id));
            groupDragHandle.addEventListener('dragend', onConfigDragEnd);

            const titleInput = document.createElement('input');
            titleInput.type = 'text';
            titleInput.className = 'config-title-input';
            titleInput.value = group.title;
            titleInput.addEventListener('input', () => {
                group.title = titleInput.value;
                updateConfigJsonPreview();
            });

            const addItemButton = document.createElement('button');
            addItemButton.type = 'button';
            addItemButton.className = 'cfg-btn';
            addItemButton.textContent = ' + ';
			addItemButton.title = 'Lisää huoltokohde tämän otsikon alle';
            addItemButton.addEventListener('click', () => addConfigItem(group.id));

            const removeGroupButton = document.createElement('button');
            removeGroupButton.type = 'button';
            removeGroupButton.className = 'cfg-btn cfg-btn-danger';
            removeGroupButton.textContent = 'Poista otsikko';
            removeGroupButton.addEventListener('click', () => removeConfigGroup(group.id));

            headerEl.appendChild(groupDragHandle);
            headerEl.appendChild(titleInput);
            headerEl.appendChild(addItemButton);
            headerEl.appendChild(removeGroupButton);

            const itemsEl = document.createElement('div');
            itemsEl.className = 'config-group-items';
            itemsEl.dataset.groupId = group.id;
            itemsEl.addEventListener('dragover', onConfigItemsContainerDragOver);
            itemsEl.addEventListener('dragleave', onConfigItemsContainerDragLeave);
            itemsEl.addEventListener('drop', event => onConfigItemsContainerDrop(event, group.id));

                group.items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'config-item';
                    itemEl.dataset.groupId = group.id;
                    itemEl.dataset.itemId = item.id;
                itemEl.addEventListener('dragover', onConfigItemDragOver);
                itemEl.addEventListener('dragleave', onConfigItemDragLeave);
                itemEl.addEventListener('drop', event => onConfigItemDrop(event, group.id, item.id));

                    const itemDragHandle = document.createElement('span');
                    itemDragHandle.className = 'drag-handle';
                    itemDragHandle.textContent = '::';
                    itemDragHandle.title = 'Vedä kohdetta';
                    itemDragHandle.draggable = true;
                    itemDragHandle.addEventListener('dragstart', event => onConfigItemDragStart(event, group.id, item.id));
                    itemDragHandle.addEventListener('dragend', onConfigDragEnd);

                    const itemInput = document.createElement('input');
                    itemInput.type = 'text';
                    itemInput.className = 'config-item-input';
                itemInput.value = item.label;
                itemInput.dataset.prevValue = item.label;
                itemInput.addEventListener('input', () => {
                    item.label = itemInput.value;
                    updateConfigJsonPreview();
                });
                itemInput.addEventListener('change', () => {
                    const candidate = itemInput.value;
                    if (hasDuplicateConfigItemLabel(candidate, group.id, item.id)) {
                        alert(`Nimi "${candidate.trim()}" on jo käytössä tässä otsikossa.`);
                        itemInput.value = itemInput.dataset.prevValue || '';
                        item.label = itemInput.value;
                        itemInput.focus();
                    } else {
                        itemInput.dataset.prevValue = itemInput.value;
                        item.label = itemInput.value;
                    }
                    updateConfigJsonPreview();
                });

                    const removeItemButton = document.createElement('button');
                    removeItemButton.type = 'button';
                    removeItemButton.className = 'cfg-btn cfg-btn-danger';
                    removeItemButton.textContent = 'Poista';
                    removeItemButton.addEventListener('click', () => removeConfigItem(group.id, item.id));

                    const addSubitemButton = document.createElement('button');
                    addSubitemButton.type = 'button';
                    addSubitemButton.className = 'cfg-btn';
                    addSubitemButton.textContent = ' + ';
                    addSubitemButton.title = 'Lisää alakohta';
                    addSubitemButton.addEventListener('click', () => addConfigSubitem(group.id, item.id));

                    const itemMainRow = document.createElement('div');
                    itemMainRow.className = 'config-item-main';
                    itemMainRow.appendChild(itemDragHandle);
                    itemMainRow.appendChild(itemInput);
                    itemMainRow.appendChild(addSubitemButton);
                    itemMainRow.appendChild(removeItemButton);
                    itemEl.appendChild(itemMainRow);

                    const subitems = normalizeSubitems(item.subitems);
                    if (subitems.length > 0) {
                        const subitemsEl = document.createElement('div');
                        subitemsEl.className = 'config-subitems';

                        subitems.forEach((subitemValue, subitemIndex) => {
                            const subitemRow = document.createElement('div');
                            subitemRow.className = 'config-subitem-row';

                            const subitemInput = document.createElement('input');
                            subitemInput.type = 'text';
                            subitemInput.className = 'config-subitem-input';
                            subitemInput.dataset.subitemIndex = String(subitemIndex);
                            subitemInput.value = subitemValue;
                            subitemInput.addEventListener('input', () => {
                                if (!Array.isArray(item.subitems)) item.subitems = [];
                                item.subitems[subitemIndex] = subitemInput.value;
                                updateConfigJsonPreview();
                            });
                            subitemInput.addEventListener('change', () => {
                                if (!Array.isArray(item.subitems)) item.subitems = [];
                                item.subitems[subitemIndex] = subitemInput.value.trim();
                                updateConfigJsonPreview();
                            });

                            const removeSubitemButton = document.createElement('button');
                            removeSubitemButton.type = 'button';
                            removeSubitemButton.className = 'cfg-btn cfg-btn-danger config-subitem-remove';
                            removeSubitemButton.textContent = 'Poista';
                            removeSubitemButton.addEventListener('click', () => removeConfigSubitem(group.id, item.id, subitemIndex));

                            subitemRow.appendChild(subitemInput);
                            subitemRow.appendChild(removeSubitemButton);
                            subitemsEl.appendChild(subitemRow);
                        });

                        itemEl.appendChild(subitemsEl);
                    }

                    itemsEl.appendChild(itemEl);
                });

            groupEl.appendChild(headerEl);
            groupEl.appendChild(itemsEl);
            groupsContainer.appendChild(groupEl);
        });

        updateConfigJsonPreview();
        renderMaintenanceSetEditor();
    }

    function getMaintenanceSetsFromEditor(maintenanceItems) {
        const normalized = normalizeMaintenanceSets({ sets: maintenanceSetEditorState.sets }, maintenanceItems || getMaintenanceItemsFromEditor());
        const sets = normalized.value.sets
            .map(set => ({
                id: set.id,
                name: set.name.trim(),
                entries: (Array.isArray(set.entries) ? set.entries : [])
                    .map(entry => ({
                        item_id: entry.item_id,
                        item_label: (entry.item_label || '').trim(),
                        status: normalizeStatus(entry.status),
                        selected_subitems: normalizeSubitems(entry.selected_subitems)
                    }))
                    .filter(entry => !!entry.item_id)
            }))
            .filter(set => set.name.length > 0 && set.entries.length > 0);
        return { sets: sets };
    }

    function initMaintenanceSetEditor(rawSets) {
        const normalized = normalizeMaintenanceSets(rawSets, getMaintenanceItemsFromEditor());
        maintenanceSetExpandedIds = new Set();
        maintenanceSetEditorState = {
            sets: normalized.value.sets.map(set => ({
                id: set.id,
                name: set.name,
                entries: (set.entries || []).map(entry => ({
                    item_id: entry.item_id,
                    item_label: entry.item_label || '',
                    status: normalizeStatus(entry.status),
                    selected_subitems: normalizeSubitems(entry.selected_subitems)
                }))
            }))
        };
        renderMaintenanceSetEditor();
    }

    function findMaintenanceSetById(setId) {
        return maintenanceSetEditorState.sets.find(set => set.id === setId) || null;
    }

    function addMaintenanceSetFromInput() {
        const input = document.getElementById('new-maintenance-set-name');
        if (!input) return;
        const name = (input.value || '').trim();
        if (!name) {
            alert('Anna huoltosetille nimi.');
            input.focus();
            return;
        }
        maintenanceSetEditorState.sets.push({ id: nextMaintenanceSetId(), name: name, entries: [] });
        input.value = '';
        renderMaintenanceSetEditor();
    }

    function removeMaintenanceSet(setId) {
        const set = findMaintenanceSetById(setId);
        if (!set) return;
        if (!confirm(`Poistetaanko huoltosetti "${set.name || 'Nimeton'}"?`)) return;
        maintenanceSetEditorState.sets = maintenanceSetEditorState.sets.filter(entry => entry.id !== setId);
        maintenanceSetExpandedIds.delete(setId);
        renderMaintenanceSetEditor();
    }

    function addMaintenanceSetEntry(setId) {
        const set = findMaintenanceSetById(setId);
        if (!set) return;
        const lookup = buildMaintenanceItemLookup(getMaintenanceItemsFromEditor());
        const firstAvailable = lookup.ordered.find(item => !set.entries.some(entry => entry.item_id === item.id));
        if (!firstAvailable) {
            alert('Huoltosettiin ei ole lisättävissä uusia kohteita.');
            return;
        }
        set.entries.push({
            item_id: firstAvailable.id,
            item_label: firstAvailable.label,
            status: 'done',
            selected_subitems: []
        });
        renderMaintenanceSetEditor();
    }

    function removeMaintenanceSetEntry(setId, itemId) {
        const set = findMaintenanceSetById(setId);
        if (!set) return;
        set.entries = set.entries.filter(entry => entry.item_id !== itemId);
        renderMaintenanceSetEditor();
    }

    function getMaintenanceSetIssues(set, maintenanceItems) {
        const lookup = buildMaintenanceItemLookup(maintenanceItems).byId;
        const missingItems = [];
        const missingSubitems = [];
        (set.entries || []).forEach(entry => {
            const itemRef = lookup.get(entry.item_id);
            if (!itemRef) {
                missingItems.push((entry.item_label || entry.item_id || 'Tuntematon kohde').trim());
                return;
            }
            const selected = normalizeSubitems(entry.selected_subitems);
            const valid = new Set(normalizeSelectedSubitems(selected, itemRef.subitems));
            const missing = selected.filter(subitem => !valid.has(subitem));
            if (missing.length > 0) {
                const label = itemRef.label || entry.item_label || entry.item_id;
                missingSubitems.push(`${label}: ${missing.join(', ')}`);
            }
        });
        return { missing_items: missingItems, missing_subitems: missingSubitems };
    }

    function renderMaintenanceSetEditor() {
        const container = document.getElementById('maintenance-set-editor');
        if (!container) return;
        const maintenanceItems = getMaintenanceItemsFromEditor();
        const lookup = buildMaintenanceItemLookup(maintenanceItems);
        const normalized = normalizeMaintenanceSets({ sets: maintenanceSetEditorState.sets }, maintenanceItems);
        maintenanceSetEditorState.sets = normalized.value.sets;
        container.innerHTML = '';
        const existingSetIds = new Set(maintenanceSetEditorState.sets.map(set => set.id));
        maintenanceSetExpandedIds.forEach(setId => {
            if (!existingSetIds.has(setId)) maintenanceSetExpandedIds.delete(setId);
        });

        maintenanceSetEditorState.sets.forEach(set => {
            const issues = getMaintenanceSetIssues(set, maintenanceItems);
            const missingRefCount = issues.missing_items.length + issues.missing_subitems.length;

            const card = document.createElement('details');
            card.className = 'maintenance-set-card';
            card.open = maintenanceSetExpandedIds.has(set.id);

            const summary = document.createElement('summary');
            summary.className = 'maintenance-set-summary';

            const summaryCaret = document.createElement('span');
            summaryCaret.className = 'maintenance-set-summary-caret';
            summaryCaret.textContent = card.open ? '▼' : '▶';

            const summaryName = document.createElement('span');
            summaryName.textContent = (set.name || 'Nimeton huoltosetti');

            const summaryMeta = document.createElement('span');
            summaryMeta.className = 'maintenance-set-summary-meta';
            summaryMeta.textContent = missingRefCount > 0
                ? `${set.entries.length} kohdetta • ${missingRefCount} puuttuvaa viittausta`
                : `${set.entries.length} kohdetta`;

            summary.appendChild(summaryCaret);
            summary.appendChild(summaryName);
            summary.appendChild(summaryMeta);
            card.appendChild(summary);

            card.addEventListener('toggle', () => {
                if (card.open) maintenanceSetExpandedIds.add(set.id);
                else maintenanceSetExpandedIds.delete(set.id);
                summaryCaret.textContent = card.open ? '▼' : '▶';
            });

            const body = document.createElement('div');
            body.className = 'maintenance-set-body';

            const header = document.createElement('div');
            header.className = 'maintenance-set-header';

            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'form-control';
            nameInput.value = set.name || '';
            nameInput.placeholder = 'Huoltosetin nimi';
            nameInput.addEventListener('input', () => {
                set.name = nameInput.value;
                summaryName.textContent = (set.name || 'Nimeton huoltosetti');
            });

            const removeSetBtn = document.createElement('button');
            removeSetBtn.type = 'button';
            removeSetBtn.className = 'cfg-btn cfg-btn-danger';
            removeSetBtn.textContent = 'Poista setti';
            removeSetBtn.addEventListener('click', () => removeMaintenanceSet(set.id));

            header.appendChild(nameInput);
            header.appendChild(removeSetBtn);
            body.appendChild(header);

            if (issues.missing_items.length > 0 || issues.missing_subitems.length > 0) {
                const warning = document.createElement('div');
                warning.className = 'maintenance-set-warnings';
                const parts = [];
                if (issues.missing_items.length > 0) parts.push(`Puuttuvat kohteet: ${issues.missing_items.join(', ')}`);
                if (issues.missing_subitems.length > 0) parts.push(`Puuttuvat alakohdat: ${issues.missing_subitems.join(', ')}`);
                warning.textContent = parts.join(' | ');
                body.appendChild(warning);
            }

            const entryList = document.createElement('div');
            entryList.className = 'maintenance-set-entry-list';

            set.entries.forEach(entry => {
                const entryRow = document.createElement('div');
                entryRow.className = 'maintenance-set-entry';

                const entryMain = document.createElement('div');
                entryMain.className = 'maintenance-set-entry-main';

                const itemSelect = document.createElement('select');
                itemSelect.className = 'form-control';
                if (entry.item_id && !lookup.byId.has(entry.item_id)) {
                    const missingOption = document.createElement('option');
                    missingOption.value = entry.item_id;
                    missingOption.textContent = `[PUUTTUU] ${entry.item_label || entry.item_id}`;
                    itemSelect.appendChild(missingOption);
                }
                lookup.ordered.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.group_title || 'Nimeton otsikko'} / ${item.label}`;
                    itemSelect.appendChild(option);
                });
                itemSelect.value = entry.item_id;
                itemSelect.addEventListener('change', () => {
                    const nextItemId = itemSelect.value;
                    if (set.entries.some(other => other !== entry && other.item_id === nextItemId)) {
                        alert('Sama kohde on jo tässä huoltosetissä.');
                        itemSelect.value = entry.item_id;
                        return;
                    }
                    const itemRef = lookup.byId.get(nextItemId);
                    entry.item_id = nextItemId;
                    entry.item_label = itemRef ? itemRef.label : '';
                    entry.selected_subitems = normalizeSelectedSubitems(entry.selected_subitems, itemRef ? itemRef.subitems : []);
                    renderMaintenanceSetEditor();
                });

                const statusSelect = document.createElement('select');
                statusSelect.className = 'maintenance-set-entry-status';
                ['done', 'not_done', 'na'].forEach(statusValue => {
                    const option = document.createElement('option');
                    option.value = statusValue;
                    option.textContent = statusTexts[statusValue];
                    statusSelect.appendChild(option);
                });
                statusSelect.value = normalizeStatus(entry.status);
                statusSelect.addEventListener('change', () => {
                    entry.status = normalizeStatus(statusSelect.value);
                });

                const removeEntryBtn = document.createElement('button');
                removeEntryBtn.type = 'button';
                removeEntryBtn.className = 'cfg-btn cfg-btn-danger';
                removeEntryBtn.textContent = 'Poista';
                removeEntryBtn.addEventListener('click', () => removeMaintenanceSetEntry(set.id, entry.item_id));

                entryMain.appendChild(itemSelect);
                entryMain.appendChild(statusSelect);
                entryMain.appendChild(removeEntryBtn);
                entryRow.appendChild(entryMain);

                const itemRef = lookup.byId.get(entry.item_id);
                if (itemRef && itemRef.subitems.length > 0) {
                    const subitemsRow = document.createElement('div');
                    subitemsRow.className = 'maintenance-set-entry-subitems';
                    const selectedSet = new Set(normalizeSelectedSubitems(entry.selected_subitems, itemRef.subitems));
                    itemRef.subitems.forEach(subitem => {
                        const chip = document.createElement('button');
                        chip.type = 'button';
                        chip.className = `maintenance-set-entry-subitem${selectedSet.has(subitem) ? ' selected' : ''}`;
                        chip.textContent = subitem;
                        chip.addEventListener('click', () => {
                            const next = new Set(normalizeSubitems(entry.selected_subitems));
                            if (next.has(subitem)) next.delete(subitem);
                            else next.add(subitem);
                            entry.selected_subitems = Array.from(next);
                            renderMaintenanceSetEditor();
                        });
                        subitemsRow.appendChild(chip);
                    });
                    entryRow.appendChild(subitemsRow);
                } else {
                    const meta = document.createElement('div');
                    meta.className = 'maintenance-set-entry-meta';
                    meta.textContent = 'Ei valittavia alakohtia.';
                    entryRow.appendChild(meta);
                }

                entryList.appendChild(entryRow);
            });
            body.appendChild(entryList);

            const actions = document.createElement('div');
            actions.className = 'maintenance-set-actions';
            const addEntryBtn = document.createElement('button');
            addEntryBtn.type = 'button';
            addEntryBtn.className = 'cfg-btn';
            addEntryBtn.textContent = ' + Lisää kohde';
            addEntryBtn.addEventListener('click', () => addMaintenanceSetEntry(set.id));
            actions.appendChild(addEntryBtn);
            body.appendChild(actions);

            card.appendChild(body);

            container.appendChild(card);
        });
        evaluateConfigDirtyState();
    }

    function renderMaintenanceSetSection() {
        const section = document.getElementById('maintenance-sets-section');
        const container = document.getElementById('maintenance-sets-container');
        if (!section || !container) return;
        container.innerHTML = '';
        const rawSets = currentConfig.maintenance_sets && Array.isArray(currentConfig.maintenance_sets.sets)
            ? currentConfig.maintenance_sets.sets
            : [];
        const normalizedSets = normalizeMaintenanceSets({ sets: rawSets }, currentConfig.maintenance_items).value.sets
            .filter(set => set.name.trim().length > 0 && Array.isArray(set.entries) && set.entries.length > 0);
        if (normalizedSets.length === 0) {
            section.style.display = 'none';
            return;
        }

        const reportLookup = buildMaintenanceItemLookup({
            groups: Array.isArray(currentReportMaintenance && currentReportMaintenance.groups)
                ? currentReportMaintenance.groups
                : getCurrentConfigGroups()
        }).byId;

        normalizedSets.forEach(set => {
            const applicableCount = set.entries.filter(entry => reportLookup.has(entry.item_id)).length;
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'maintenance-set-chip';
            chip.textContent = set.name;
            chip.disabled = applicableCount === 0;
            chip.title = applicableCount > 0
                ? `Käytä huoltosettiä (${applicableCount} kohdetta)`
                : 'Setin kohteita ei löydy nykyisestä raportista';
            chip.addEventListener('click', () => applyMaintenanceSet(set.id));
            container.appendChild(chip);
        });
        section.style.display = 'block';
    }

    function applyMaintenanceSet(setId) {
        const rawSets = currentConfig.maintenance_sets && Array.isArray(currentConfig.maintenance_sets.sets)
            ? currentConfig.maintenance_sets.sets
            : [];
        const normalizedSets = normalizeMaintenanceSets({ sets: rawSets }, currentConfig.maintenance_items).value.sets;
        const selectedSet = normalizedSets.find(set => set.id === setId);
        if (!selectedSet) return;

        const working = collectMaintenanceV2ForSave();
        const byItemId = new Map();
        working.groups.forEach(group => {
            group.items.forEach(item => byItemId.set(item.id, item));
        });

        let appliedCount = 0;
        let changed = false;
        selectedSet.entries.forEach(entry => {
            const item = byItemId.get(entry.item_id);
            if (!item) return;
            const nextStatus = normalizeStatus(entry.status);
            const nextSubitems = normalizeSelectedSubitems(entry.selected_subitems, item.subitems);
            if (item.status !== nextStatus) changed = true;
            if (JSON.stringify(normalizeSubitems(item.selected_subitems)) !== JSON.stringify(nextSubitems)) changed = true;
            item.status = nextStatus;
            item.selected_subitems = nextSubitems;
            appliedCount += 1;
        });

        if (appliedCount === 0) {
            alert('Huoltosetin kohteita ei löytynyt tästä raportista.');
            return;
        }

        currentReportMaintenance = working;
        renderMaintenanceSections();
        if (changed) {
            evaluateReportDirtyState();
        }
    }

    function removeLegacyItem(legacyId, skipConfirm = false) {
        const legacyItems = Array.isArray(currentReportMaintenance.legacy_items) ? currentReportMaintenance.legacy_items : [];
        const entry = legacyItems.find(item => item.id === legacyId);
        if (!entry) return;
        if (!skipConfirm && !confirm(`Poistetaanko poistunut kohde "${entry.label}" tältä raportilta?`)) return;
        const statuses = captureStatusesByItemId();
        const notes = captureNotesByItemId();
        const selectedSubitems = captureSelectedSubitemsByItemId();
        currentReportMaintenance.legacy_items = legacyItems.filter(item => item.id !== legacyId);
        renderMaintenanceSections();
        restoreStatusesByItemId(statuses);
        restoreNotesByItemId(notes);
        restoreSelectedSubitemsByItemId(selectedSubitems);
        evaluateReportDirtyState();
    }

    function mapLegacyItemToCurrent(legacyId, targetItemId) {
        if (!targetItemId) {
            alert('Valitse ensin vastine nykyisistä huoltokohteista.');
            return;
        }
        const legacyItems = Array.isArray(currentReportMaintenance.legacy_items) ? currentReportMaintenance.legacy_items : [];
        const legacyItem = legacyItems.find(item => item.id === legacyId);
        if (!legacyItem) return;

        const targetEl = Array.from(document.querySelectorAll('.maintenance-item:not(.legacy-item)'))
            .find(el => el.dataset.itemId === targetItemId);
        if (!targetEl) {
            alert('Valittua kohdetta ei löytynyt aktiivisesta listasta.');
            return;
        }

        const input = getStatusInputForItemElement(targetEl);
        const currentStatus = input ? normalizeStatus(input.value) : 'na';
        if (currentStatus !== 'na' && currentStatus !== legacyItem.status) {
            const ok = confirm(`Kohteella on jo tila "${statusTexts[currentStatus]}". Korvataanko se tilalla "${statusTexts[legacyItem.status]}"?`);
            if (!ok) return;
        }

        selectStatus(targetEl.id, legacyItem.status);
        removeLegacyItem(legacyId, true);
    }

    function updateReportTemplateToCurrentSettings() {
        const existing = collectMaintenanceV2ForSave();
        const previousItems = [];
        const byId = new Map();
        const byLabel = new Map();
        let counter = 0;

        existing.groups.forEach(group => {
            group.items.forEach(item => {
                const entry = {
                    key: `prev_${counter++}`,
                    id: item.id,
                    label: item.label,
                    status: normalizeStatus(item.status),
                    selected_subitems: normalizeSelectedSubitems(item.selected_subitems, item.subitems),
                    note: normalizeMaintenanceNote(item.note),
                    group_title: group.title
                };
                previousItems.push(entry);
                if (entry.id && !byId.has(entry.id)) byId.set(entry.id, entry);
                const normalizedLabel = normalizeConfigItemLabel(entry.label);
                if (!normalizedLabel) return;
                if (!byLabel.has(normalizedLabel)) byLabel.set(normalizedLabel, []);
                byLabel.get(normalizedLabel).push(entry);
            });
        });

        const used = new Set();
        const updatedGroups = getCurrentConfigGroups();
        updatedGroups.forEach(group => {
            group.items.forEach(item => {
                let match = null;
                if (item.id && byId.has(item.id)) {
                    match = byId.get(item.id);
                } else {
                    const candidates = byLabel.get(normalizeConfigItemLabel(item.label)) || [];
                    match = candidates.find(entry => !used.has(entry.key)) || null;
                }
                if (match) {
                    item.status = normalizeStatus(match.status);
                    item.selected_subitems = normalizeSelectedSubitems(match.selected_subitems, item.subitems);
                    item.note = normalizeMaintenanceNote(match.note);
                    used.add(match.key);
                } else {
                    item.status = 'na';
                    item.selected_subitems = [];
                    item.note = '';
                }
            });
        });

        const orphaned = previousItems
            .filter(entry => !used.has(entry.key))
            .map(entry => ({
                id: nextLegacyItemId(),
                label: entry.label,
                status: normalizeStatus(entry.status)
            }));

        const nextLegacyItems = dedupeLegacyItems([...(existing.legacy_items || []), ...orphaned]);
        currentReportMaintenance = {
            schema_version: MAINTENANCE_SCHEMA_VERSION,
            groups: updatedGroups,
            legacy_items: nextLegacyItems
        };
        currentReportHasSettingsMismatch = false;
        currentReportLoadedFromLegacyFormat = false;
        renderMaintenanceSections();
        // Conversion should always require explicit save.
        setReportDirty(true);
        if (nextLegacyItems.length > 0) {
            alert('Raportin toimenpidemalli päivitettiin nykyisiin asetuksiin. Tarkista mahdolliset "Poistuneet huoltotoimenpiteet" ja korvaa ne uusilla vastineillaan. Muista tallentaa raportti.');
        } else {
            alert('Raportin toimenpidemalli päivitettiin nykyisiin asetuksiin. Muista tallentaa raportti.');
        }
    }

    function renderMaintenanceSections() {
        const container = document.getElementById('maintenance-sections-container');
        if (!container) return;
        container.innerHTML = '';

        const groups = cloneMaintenanceGroups(currentReportMaintenance.groups || [], 'na');
        const legacyItems = dedupeLegacyItems(normalizeLegacyItems(currentReportMaintenance.legacy_items));
        currentReportMaintenance.groups = groups;
        currentReportMaintenance.legacy_items = legacyItems;

        if (legacyItems.length > 0) {
            const legacySection = document.createElement('div');
            legacySection.className = 'document-section';

            const header = document.createElement('div');
            header.className = 'document-section-header legacy-section-header';
            header.textContent = 'Poistuneet huoltotoimenpiteet';

            const content = document.createElement('div');
            content.className = 'document-section-content';

            const helpText = document.createElement('p');
            helpText.className = 'legacy-help-text';
            helpText.textContent = LEGACY_REPLACEMENT_HELP_TEXT;
            content.appendChild(helpText);

            legacyItems.forEach(legacyItem => {
                const itemEl = document.createElement('div');
                itemEl.className = 'maintenance-item legacy-item';
                itemEl.dataset.label = legacyItem.label;
                itemEl.dataset.legacyId = legacyItem.id;

                const titleRow = document.createElement('div');
                titleRow.className = 'legacy-title-row';

                const titleEl = document.createElement('div');
                titleEl.className = 'maintenance-title legacy-title';
                titleEl.textContent = legacyItem.label;

                const appendixEl = document.createElement('span');
                appendixEl.className = 'legacy-appendix';
                appendixEl.textContent = ' - Aiemmin merkitty huoltotoimenpide';
                titleEl.appendChild(appendixEl);

                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'legacy-remove-btn';
                removeBtn.textContent = 'Poista';
                removeBtn.addEventListener('click', () => removeLegacyItem(legacyItem.id));

                titleRow.appendChild(titleEl);
                titleRow.appendChild(removeBtn);

                const statusRow = document.createElement('div');
                statusRow.className = 'legacy-status-row';
                statusRow.textContent = `Tila: ${statusTexts[legacyItem.status]}`;

                const mapRow = document.createElement('div');
                mapRow.className = 'legacy-map-row';

                const mapSelect = document.createElement('select');
                mapSelect.className = 'legacy-map-select';
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Valitse vastine asetuksista...';
                mapSelect.appendChild(placeholder);

                groups.forEach(group => {
                    group.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        const groupTitle = (group.title || '').trim() || 'Nimeton otsikko';
                        option.textContent = `${groupTitle} / ${item.label}`;
                        mapSelect.appendChild(option);
                    });
                });

                const mapBtn = document.createElement('button');
                mapBtn.type = 'button';
                mapBtn.className = 'legacy-map-btn';
                mapBtn.textContent = 'Korvaa';
                mapBtn.disabled = groups.length === 0;
                mapBtn.addEventListener('click', () => mapLegacyItemToCurrent(legacyItem.id, mapSelect.value));

                mapRow.appendChild(mapSelect);
                mapRow.appendChild(mapBtn);

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.value = legacyItem.status;

                itemEl.appendChild(titleRow);
                itemEl.appendChild(statusRow);
                itemEl.appendChild(mapRow);
                itemEl.appendChild(hiddenInput);
                content.appendChild(itemEl);
            });

            legacySection.appendChild(header);
            legacySection.appendChild(content);
            container.appendChild(legacySection);
        }

        const optionsMeta = [
            { value: 'done', icon: 'fa-check-circle', text: statusTexts.done },
            { value: 'not_done', icon: 'fa-times-circle', text: statusTexts.not_done },
            { value: 'na', icon: 'fa-minus-circle', text: statusTexts.na }
        ];

        groups.forEach((group, groupIndex) => {
            const section = document.createElement('div');
            section.className = 'document-section';

            const header = document.createElement('div');
            header.className = 'document-section-header';
            header.textContent = group.title;

            const content = document.createElement('div');
            content.className = 'document-section-content';

            group.items.forEach((item, itemIndex) => {
                const itemDomId = `item_${groupIndex}_${itemIndex}`;
                const itemEl = document.createElement('div');
                itemEl.className = 'maintenance-item';
                itemEl.id = itemDomId;
                itemEl.dataset.label = item.label;
                itemEl.dataset.groupId = group.id;
                itemEl.dataset.itemId = item.id;

                const titleRow = document.createElement('div');
                titleRow.className = 'maintenance-title-row';

                const titleEl = document.createElement('div');
                titleEl.className = 'maintenance-title';
                titleEl.textContent = item.label;

                const noteToggle = document.createElement('button');
                noteToggle.type = 'button';
                noteToggle.className = 'item-note-toggle';
                noteToggle.textContent = '+i';
                noteToggle.title = 'Lisää kohdekohtainen huomio';

                const selector = document.createElement('div');
                selector.className = 'status-selector';
                const selectedStatus = normalizeStatus(item.status);
                optionsMeta.forEach(meta => {
                    const option = document.createElement('div');
                    option.className = `status-option${meta.value === selectedStatus ? ' selected' : ''}`;
                    option.dataset.value = meta.value;
                    option.innerHTML = `<i class="fas ${meta.icon}"></i> ${escapeHtml(meta.text)}`;
                    option.addEventListener('click', () => selectStatus(itemDomId, meta.value));
                    selector.appendChild(option);
                });

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = `status_${itemDomId}`;
                hiddenInput.dataset.role = 'status';
                hiddenInput.value = selectedStatus;

                const subitems = normalizeSubitems(item.subitems);
                const selectedSubitems = normalizeSelectedSubitems(item.selected_subitems, subitems);
                const noteValue = normalizeMaintenanceNote(item.note);

                let subitemsRow = null;
                if (subitems.length > 0) {
                    subitemsRow = document.createElement('div');
                    subitemsRow.className = 'maintenance-subitems-row';
                    const selectedSet = new Set(selectedSubitems);
                    subitems.forEach(subitem => {
                        const chip = document.createElement('button');
                        chip.type = 'button';
                        chip.className = `maintenance-subitem-btn${selectedSet.has(subitem) ? ' selected' : ''}`;
                        chip.dataset.subitemValue = subitem;
                        chip.textContent = subitem;
                        chip.setAttribute('aria-pressed', selectedSet.has(subitem) ? 'true' : 'false');
                        chip.title = 'Valitse tulostettava lisatieto';
                        chip.addEventListener('click', () => {
                            const isSelected = chip.classList.toggle('selected');
                            chip.setAttribute('aria-pressed', isSelected ? 'true' : 'false');
                            evaluateReportDirtyState();
                        });
                        subitemsRow.appendChild(chip);
                    });
                }

                const noteRow = document.createElement('div');
                noteRow.className = 'maintenance-note-row';
                noteRow.style.display = noteValue ? 'block' : 'none';

                const noteInput = document.createElement('input');
                noteInput.type = 'text';
                noteInput.className = 'form-control maintenance-note-input';
                noteInput.placeholder = 'Lisää huomautus...';
                noteInput.value = noteValue;
                noteInput.addEventListener('input', () => {
                    noteToggle.classList.toggle('active', normalizeMaintenanceNote(noteInput.value).length > 0 || noteRow.style.display !== 'none');
                });
                noteRow.appendChild(noteInput);

                noteToggle.classList.toggle('active', noteValue.length > 0);
                noteToggle.addEventListener('click', () => {
                    const isHidden = noteRow.style.display === 'none';
                    noteRow.style.display = isHidden ? 'block' : 'none';
                    noteToggle.classList.toggle('active', isHidden || normalizeMaintenanceNote(noteInput.value).length > 0);
                    if (isHidden) noteInput.focus();
                });

                titleRow.appendChild(titleEl);
                titleRow.appendChild(noteToggle);

                itemEl.appendChild(titleRow);
                itemEl.appendChild(selector);
                if (subitemsRow) itemEl.appendChild(subitemsRow);
                itemEl.appendChild(noteRow);
                itemEl.appendChild(hiddenInput);
                content.appendChild(itemEl);
            });

            section.appendChild(header);
            section.appendChild(content);
            container.appendChild(section);
        });

        renderMaintenanceSetSection();
        updateReportUpdateBanner();
    }

    window.selectStatus = function(itemId, status) {
        const container = document.getElementById(itemId);
        if (!container) return;
        const input = getStatusInputForItemElement(container);
        if (!input) return;
        const normalized = normalizeStatus(status);
        input.value = normalized;
        container.querySelectorAll('.status-option').forEach(opt => {
            opt.classList.remove('selected');
            if (opt.dataset.value === normalized) opt.classList.add('selected');
        });
        evaluateReportDirtyState();
    }

    async function lookupVehicle() {
        const plate = document.getElementById('license_plate').value;
        if (plate.length < 2) return;
        const res = await apiFetch(`api/lookup_vehicle?plate=${encodeURIComponent(plate)}`);
        const data = await res.json();
        if (data.vin) {
            let changed = false;
            ['vin', 'vehicle_model', 'engine_code', 'registered_date'].forEach(f => {
                const input = document.getElementById(f);
                if(!input.value) {
                    input.value = data[f] || '';
                    changed = true;
                }
            });
            if (changed) evaluateReportDirtyState();
        }
    }

    async function saveReport(silent = false) {
        const report = buildReportPayloadFromEditor();

        const res = await apiFetch('api/save_report', { method: 'POST', body: JSON.stringify(report) });
        const result = await res.json();
        if (result.status === 'created' || result.status === 'updated') {
            document.getElementById('report-id').value = result.id;
            invalidateCalendarCache();
            markCurrentReportAsSaved();
            if(!silent) alert('Raportti tallennettu!');
            return true;
        } else {
            alert('Virhe tallennuksessa');
            return false;
        }
    }

    async function openReport(id) {
        const res = await apiFetch(`api/report?id=${id}`);
        const data = await res.json();
        withDirtyTrackingPaused(() => {
            createNewReport({ skipUnsavedPrompt: true, skipBaseline: true });
            document.getElementById('report-id').value = data.id;
            document.getElementById('customer_name').value = data.customer_name || '';
            document.getElementById('report_date').value = data.report_date || '';
            document.getElementById('pre_info').value = data.pre_info || '';
            document.getElementById('license_plate').value = data.license_plate || '';
            document.getElementById('vin').value = data.vin || '';
            document.getElementById('vehicle_model').value = data.vehicle_model || '';
            document.getElementById('engine_code').value = data.engine_code || '';
            document.getElementById('registered_date').value = data.registered_date || '';
            document.getElementById('mileage').value = data.mileage || '';
            document.getElementById('additional_notes').value = data.additional_notes || '';
            document.getElementById('mechanic_signature').value = data.mechanic_signature || '';
            currentAttachments = data.attachments || [];
            renderAttachmentList();
            readMaintenanceForCurrentReport(data);
            renderMaintenanceSections();
        });
        markCurrentReportAsSaved();
        switchView('editor-view');
    }
	
    async function saveConfig() {
        let maintenanceItems = null;
        const configJsonInput = document.getElementById('config-json');
        try {
            const rawParsed = JSON.parse(configJsonInput.value);
            maintenanceItems = normalizeMaintenanceConfig(rawParsed).value;
        } catch (e) {
            alert('Virheellinen JSON! Tarkista syntaksi.');
            return;
        }

        const duplicateLabels = getDuplicateConfigItemLabelsInSameGroupFromMaintenance(maintenanceItems);
        if (duplicateLabels.length > 0) {
            const first = duplicateLabels[0];
            alert(`Sama kohdenimi löytyi saman otsikon alta (${first.groupTitle}: ${first.label}). Korjaa duplikaatit tästä otsikosta ennen tallennusta.`);
            return;
        }
        const maintenanceSets = getMaintenanceSetsFromEditor(maintenanceItems);
        const statusLabels = normalizeStatusLabels({
            done: document.getElementById('conf_status_done').value,
            not_done: document.getElementById('conf_status_not_done').value,
            na: document.getElementById('conf_status_na').value
        });
        const shopSettings = {
            company_text: document.getElementById('conf_company_text').value,
            hide_na_in_print: document.getElementById('conf_hide_na').checked,
            accent_color: normalizeAccentColor(document.getElementById('conf_accent_color').value),
            status_labels: statusLabels
        };
        const usePassword = document.getElementById('conf_use_password').checked;
        const newPassword = document.getElementById('conf_api_password').value || '';
        const security = { password: null };
        if (!usePassword) {
            security.password = '';
        } else if (newPassword.trim()) {
            security.password = newPassword;
        } else if (!(currentConfig.security && currentConfig.security.password_enabled)) {
            alert('Anna salasana, jotta suojaus voidaan ottaa käyttöön.');
            return;
        }
        applyAccentColor(shopSettings.accent_color);
        applyStatusLabels(shopSettings.status_labels);
        await apiFetch('api/save_config', {
            method: 'POST',
            body: JSON.stringify({
                maintenance_items: maintenanceItems,
                maintenance_sets: maintenanceSets,
                shop_settings: shopSettings,
                security: security
            })
        });
        markCurrentConfigAsSaved();
        alert('Asetukset tallennettu!');
        window.location.reload();
    }

    async function preparePrint() {
        if(!(await saveReport(true))) return;

        const hideNa = currentConfig.shop_settings && currentConfig.shop_settings.hide_na_in_print;
        const printView = document.getElementById('print-view');
        printView.className = hideNa ? 'hide-na' : '';

        // Fill Data
        document.getElementById('p_company').textContent = (currentConfig.shop_settings && currentConfig.shop_settings.company_text) ? currentConfig.shop_settings.company_text : '';
        document.getElementById('p_customer').textContent = document.getElementById('customer_name').value;
        document.getElementById('p_date').textContent = document.getElementById('report_date').value;
        document.getElementById('p_plate').textContent = document.getElementById('license_plate').value;
        document.getElementById('p_vin').textContent = document.getElementById('vin').value;
        document.getElementById('p_model').textContent = document.getElementById('vehicle_model').value;
        document.getElementById('p_engine').textContent = document.getElementById('engine_code').value;
        document.getElementById('p_regdate').textContent = document.getElementById('registered_date').value;
        document.getElementById('p_mileage').textContent = document.getElementById('mileage').value;
        const preInfo = document.getElementById('pre_info').value;
        document.getElementById('p_preinfo').textContent = preInfo;
        document.getElementById('p_preinfo_row').style.display = preInfo.trim() ? 'block' : 'none';
        
        const notes = document.getElementById('additional_notes').value;
        document.getElementById('p_notes').textContent = notes;
        document.getElementById('p_notes_container').style.display = notes.trim() ? 'block' : 'none';
        document.getElementById('p_signature').textContent = document.getElementById('mechanic_signature').value;

        // Logo
        const logoImg = document.getElementById('p_logo_img');
        await new Promise(resolve => {
            logoImg.onload = () => { logoImg.style.display = 'block'; resolve(); };
            logoImg.onerror = () => { logoImg.style.display = 'none'; resolve(); };
            logoImg.src = `api/attachment?id=${STATIC_LOGO_ID}&t=${Date.now()}`;
        });

        // Maintenance
        const maintenanceV2 = collectMaintenanceV2ForSave();
        currentReportMaintenance = maintenanceV2;
        const pContainer = document.getElementById('p_maintenance_content');
        pContainer.innerHTML = '';

        maintenanceV2.groups.forEach(group => {
            let sectionItemsHtml = '';
            let visibleCount = 0;
            group.items.forEach(item => {
                const status = normalizeStatus(item.status);
                if (status !== 'na') visibleCount++;
                sectionItemsHtml += `<tr class="${status === 'na' ? 'row-na' : ''}"><td class="print-item-name">${escapeHtml(formatMaintenanceItemLabelForPrint(item))}</td><td class="print-item-status status-${status}">${statusTexts[status]}</td></tr>`;
            });
            if ((!hideNa || (hideNa && visibleCount > 0)) && group.items.length > 0) {
                pContainer.innerHTML += `<div class="print-section-title">${escapeHtml(group.title)}</div><table class="print-items-table"><tbody>${sectionItemsHtml}</tbody></table>`;
            }
        });

        // Legacy/removed items are intentionally not printed.
        // Attachments
        const pAttContainer = document.getElementById('p_attachments');
        pAttContainer.innerHTML = '';
        const attWrapper = document.getElementById('p_attachments_container');
        const attachmentLoadPromises = [];
        
        if (currentAttachments.length > 0) {
            attWrapper.style.display = 'block';
            currentAttachments.forEach(uuid => {
                const img = document.createElement('img');
                const loadPromise = new Promise(resolve => {
                    img.onload = () => resolve();
                    img.onerror = () => resolve();
                });
                img.src = `api/attachment?id=${encodeURIComponent(uuid)}&t=${Date.now()}`;
                pAttContainer.appendChild(img);
                attachmentLoadPromises.push(loadPromise);
            });
        } else {
            attWrapper.style.display = 'none';
        }
        await Promise.all(attachmentLoadPromises);

        // --- Page Break Optimizer ---
        // Temporarily display print view to measure content height
        const originalStyle = {
            display: printView.style.display,
            visibility: printView.style.visibility,
            position: printView.style.position,
            zIndex: printView.style.zIndex
        };

        printView.style.display = 'block';
        printView.style.visibility = 'hidden';
        printView.style.position = 'absolute';
        printView.style.top = '0';
        printView.style.left = '0';
        printView.style.width = '100%';
        printView.style.zIndex = '-9999';

        // Wait for render cycle (though sync access to offsetHeight triggers reflow)
        const footer = document.querySelector('.print-footer-container');
        // Calculate where the footer ends
        const footerBottom = footer.getBoundingClientRect().bottom + window.scrollY;
        
        // Conservative Page Height (A4 @ 96DPI is ~1123px). 
        // Using 1000px to safeguard against margins and browser differences.
        const PAGE_HEIGHT = 1000; 
        
        const positionOnPage = footerBottom % PAGE_HEIGHT;
        const spaceRemaining = PAGE_HEIGHT - positionOnPage;
        
        // Reset class
        attWrapper.classList.remove('force-break');
        
        // Logic: If attachments exist and we have less than ~250px remaining space on current page
        // (enough for title and header or small image), force a break.
        // However, if we are very near top of page (positionOnPage small), spaceRemaining is large, so no break.
        if (currentAttachments.length > 0 && spaceRemaining < 250) {
            attWrapper.classList.add('force-break');
        }

        // Restore styles
        printView.style.display = originalStyle.display;
        printView.style.visibility = originalStyle.visibility;
        printView.style.position = originalStyle.position;
        printView.style.zIndex = originalStyle.zIndex;

        window.print();
    }
</script>

</body>
</html>
